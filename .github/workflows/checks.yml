name: CI

on:
  push:
    branches: main
  pull_request:
    branches: ["*"]

jobs:
  check:
    runs on: ubuntu-latest

    env:
      PORT: 3306
      DATABASE_URL: mysql://root:root@localhost:3306/db

    steps:
      # Checkout repo
      - uses: actions/checkout@v4

      # Setup Node with caching
      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      # Install dependencies once
      - run: npm ci

      # -----------------------------
      # Format checks
      # -----------------------------
      - name: Format check (client)
        run: npm run --workspace client format:check

      - name: Format check (server)
        run: npm run --workspace server format:check

      - name: Format check (shared)
        run: npm run --workspace shared format:check

      # -----------------------------
      # Lint checks
      # -----------------------------
      - name: Lint (client)
        run: npm run --workspace client lint:check

      - name: Lint (server)
        run: npm run --workspace server lint:check

      - name: Lint (shared)
        run: npm run --workspace shared lint:check

      # -----------------------------
      # Build
      # -----------------------------
      - name: Build client
        run: npm run --workspace client build

      - name: Build server
        run: npm run --workspace server build

      # -----------------------------
      # Start MySQL + Test server
      # -----------------------------
      - name: Start MySQL
        run: |
          sudo /etc/init.d/mysql start
          mysql -e "CREATE DATABASE IF NOT EXISTS db;" -uroot -proot

      - name: Test server
        run: npm test --workspace server
