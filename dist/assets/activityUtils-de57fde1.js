import{al as M,am as R,ad as I,ai as $,an as L,ao as x,ap as z,aq as W,ar as j,as as q,at as F}from"./index-1922ac75.js";function P(){let n=M(),t=R(),e={};for(let a in n)e[a.toLowerCase()]=a;let s={};for(let a in n)Object.defineProperty(s,a,{get:function(){let u=n[a].returnStateVariableInfo();return delete s[a],s[a]=u}.bind(this),configurable:!0});let l={};for(let a in n)Object.defineProperty(l,a,{get:function(){let u=n[a].returnStateVariableInfo({onlyPublic:!0});return delete l[a],l[a]=u}.bind(this),configurable:!0});function o({inheritedComponentType:a,baseComponentType:u}){if(a===u)return!0;if(a==="string")return u==="_base"||u==="_inline";if(u==="string")return!1;let r=n[u];return r?r.isPrototypeOf(n[a]):!1}function i({componentType:a,includeNonStandard:u=!0}){let r=n[a];return r?o({inheritedComponentType:a,baseComponentType:"_composite"})&&(u||!r.treatAsComponentForRecursiveReplacements):!1}let c=(a,u)=>o({inheritedComponentType:a,baseComponentType:u});return{allComponentClasses:n,componentTypesCreatingVariants:t,componentTypeLowerCaseMapping:e,isInheritedComponentType:o,isCompositeComponent:i,stateVariableInfo:s,publicStateVariableInfo:l,componentIsSpecifiedType:(a,u)=>{var r,p;return c(a.componentType,u)||c((p=(r=a.attributes)==null?void 0:r.createComponentOfType)==null?void 0:p.primitive,u)}}}async function T({cid:n,doenetML:t}){t===void 0?t=await I(n,"doenet"):n||(n=await $(t));let e=P(),{fullSerializedComponents:s}=await L({contentIds:[n],doenetMLs:[t],componentInfoObjects:e}),l=s[0];x(l);let o=l[0],i=z({serializedComponent:o,componentInfoObjects:e}),c=i.numberOfVariants,f;if(i.variantNames){let a=[...i.variantNames];if(a.length>=c)a=a.slice(0,c);else{let u=[...a],r=a.length,p=r,d;for(;r<c;){for(r++,p++,d=O(p);u.includes(d);)p++,d=O(p);a.push(d)}}f=a}else f=[...Array(c).keys()].map(a=>O(a+1));return{allPossibleVariants:f,doenetML:t,cid:n}}function O(n){return W(n,!0)}function k(n,t,e){let s=e&&e.state;s&&(typeof s=="object"&&t.copy(s,t),n.state=()=>t.copy(t,{}))}function _(n,t){let e=new B(n),s=()=>e.next();return s.double=()=>s()+(s()*2097152|0)*11102230246251565e-32,s.int32=()=>e.next()*4294967296|0,s.quick=s,k(s,e,t),s}class B{constructor(t){t==null&&(t=+new Date);let e=4022871197;this.c=1,this.s0=s(" "),this.s1=s(" "),this.s2=s(" "),this.s0-=s(t),this.s0<0&&(this.s0+=1),this.s1-=s(t),this.s1<0&&(this.s1+=1),this.s2-=s(t),this.s2<0&&(this.s2+=1);function s(l){l=String(l);for(let o=0;o<l.length;o++){e+=l.charCodeAt(o);let i=.02519603282416938*e;e=i>>>0,i-=e,i*=e,e=i>>>0,i-=e,e+=i*4294967296}return(e>>>0)*23283064365386963e-26}}next(){let{c:t,s0:e,s1:s,s2:l}=this,o=2091639*e+t*23283064365386963e-26;return this.s0=s,this.s1=l,this.s2=o-(this.c=o|0)}copy(t,e){return e.c=t.c,e.s0=t.s0,e.s1=t.s1,e.s2=t.s2,e}}let E=_;function U(n){let t=j(n).filter(i=>typeof i!="string"||/\S/.test(i));if(t.length!==1||t[0].componentType!=="document")return{success:!1,message:"Invalid activity definition"};t=t[0];let e={};for(let i in t.props){let c=i.toLowerCase();if(c in e)return{success:!1,message:`Invalid activity definition: duplicate attribute ${c}`};e[i.toLowerCase()]=t.props[i]}let s;if(e.type.toLowerCase()==="activity"){let i={type:"activity"};if(delete e.type,e.itemweights){if(typeof e.itemweights!="string")return{success:!1,message:"Invalid activity definition: invalid itemWeights"};i.itemWeights=e.itemweights.split(/\s+/).filter(a=>a).map(Number),delete e.itemweights}if(i.shuffleItemWeights=e.shuffleitemweights!==void 0&&(e.shuffleitemweights===!0||e.shuffleitemweights.toLowerCase()==="true"),delete e.shuffleitemweights,i.isSinglePage=e.issinglepage!==void 0&&(e.issinglepage===!0||e.issinglepage.toLowerCase()==="true"),delete e.issinglepage,e.xmlns)if(e.xmlns.slice(0,34)==="https://doenet.org/spec/doenetml/v")i.version=e.xmlns.slice(34),s=e.xmlns,delete e.xmlns;else return{success:!1,message:"Invalid activity definition: unrecognized xmlns"};else console.warn("no xmlns of activity!");if(e.numberofvariants&&(i.numberOfVariants=Number(e.numberofvariants),delete e.numberofvariants),Object.keys(e).length>0)return{success:!1,message:`Invalid activity definition: invalid document attributes: ${Object.keys(e).join(", ")}`};let c={type:"order",behavior:"sequence",children:t.children},f=l(c);return f.success?(i.order=f.order,{success:!0,activityJSON:i}):{success:!1,message:`Invalid activity definition: ${f.message}`}}else if(e.type.toLowerCase()==="page"){let c={type:"activity",order:{type:"order",behavior:"sequence",content:[{type:"page",doenetML:n}]}};if(e.xmlns)if(e.xmlns.slice(0,34)==="https://doenet.org/spec/doenetml/v")c.version=e.xmlns.slice(34),delete e.xmlns;else return{success:!1,message:"Invalid activity definition: unrecognized xmlns"};else console.warn("no xmlns of activity!");return{success:!0,activityJSON:c}}else return{success:!1,message:"Invalid activity definition"};function l(i){let c={type:"order"},f={};for(let r in i.props){let p=r.toLowerCase();if(p in f)return{success:!1,message:`duplicate attribute of order ${p}`};f[r.toLowerCase()]=i.props[r]}for(let r in f)if(r==="behavior")c.behavior=f.behavior;else if(r=="numbertoselect")c.numberToSelect=Number(f.numbertoselect);else if(r=="withreplacement")c.withReplacement=f.withreplacement!==void 0&&(f.withreplacement===!0||f.withreplacement.toLowerCase()==="true");else return{success:!1,message:`invalid order attribute: ${r}`};let a=i.children.filter(r=>typeof r!="string"||/\S/.test(r)),u=[];for(let r of a)if(r.componentType.toLowerCase()==="order"){let p=l(r);if(p.success)u.push(p.order);else return p}else if(r.componentType.toLowerCase()=="page"){let p=o(r);if(p.success)u.push(p.page);else return p}else return{success:!1,message:`invalid child of order, found type: ${r.componentType}`};return c.content=u,{success:!0,order:c}}function o(i){var a;let c={type:"page"},f={};for(let u in i.props){let r=u.toLowerCase();if(r in f)return{success:!1,message:`duplicate attribute of page ${r}`};f[u.toLowerCase()]=i.props[u]}for(let u in f)if(u==="cid")c.cid=f.cid,delete f.cid;else return{success:!1,message:`invalid page attribute: ${u}`};if(i.children.length>0){let u=n.slice(i.range.openEnd,i.range.closeBegin);if(((a=i.children[0].componentType)==null?void 0:a.toLowerCase())!=="document"){let r="";s&&(r=` xmlns="${s}"`),u=`<document type="page" ${r}>${u}</document>`}c.doenetML=u}return{success:!0,page:c}}}async function X({activityDefinition:n,requestedVariantIndex:t}){let e=await S(n),s=(t-1)%e.numberOfVariants+1;if(s<1&&(s+=e.numberOfVariants),!Number.isFinite(s))return{success:!1,message:"Invalid requested variant index"};let l=new E(s.toString()),o=C(n.order,l);if(!o.success)return o;let i=o.pages,c=n.itemWeights||[];if(!Array.isArray(c)||!c.every(m=>m>=0))return{success:!1,message:"Invalid itemWeights"};let f=i.length;c=c.slice(0,f),c.length<f&&c.push(...Array(f-c.length).fill(1));let a=c.reduce((m,g)=>m+g);a>0&&(c=c.map(m=>m/a));let u;if(e.pageVariants)u=[e.pageVariants];else{let m=[];for(let g of i)m.push(T({cid:g.cid,doenetML:g.doenetML}));try{u=await Promise.all(m)}catch(g){return{success:!1,message:`Error retrieving content for activity. ${g.message}`}}}let r,p=[],d=[];for(let m of u)p.push(m.allPossibleVariants),d.push(m.allPossibleVariants.length);let y=d.reduce((m,g)=>m*g,1);if(y<=e.numberOfVariants){let m=(s-1)%y+1;r=q({numberOfOptionsByIndex:d,maxNumber:m})[m-1].map(g=>g+1)}else r=[...Array(f).keys()].map(m=>Math.floor(l()*d[m])+1);let h=[],v=[];for(let[m,g]of u.entries()){let N=r[m];h.push(N);let b=i[m];b.doenetML===void 0?(b={...b},b.doenetML=g.doenetML):b.cid||(b={...b},b.cid=g.cid),v.push(b)}let w=[...i];v.forEach((m,g)=>w[g].cid=m.cid);let V=await K(v),A={orderWithCids:w,variantsByPage:h,itemWeights:c,numberOfVariants:e.numberOfVariants,previousComponentTypeCounts:V};return{success:!0,order:v,itemWeights:c,variantsByPage:h,variantIndex:s,activityInfo:A,previousComponentTypeCounts:V}}async function S(n){let t=1e3,e=null;if(n.numberOfVariants!==void 0)t=n.numberOfVariants,Number.isInteger(t)&&t>=1||(t=1e3);else if((n.order.behavior===void 0||n.order.behavior==="sequence")&&n.order.content.every(s=>s.type==="page")){let s=[];for(let l of n.order.content)s.push(T({cid:l.cid,doenetML:l.doenetML}));e=await Promise.all(s),t=e.reduce((l,o)=>l*o.allPossibleVariants.length,1),t=Math.min(1e3,t)}return{numberOfVariants:t,pageVariantsResult:e}}async function Y(n){let t=await I(n),e=U(t);return e.success?(e=await S(e.activityJSON),{success:!0,numberOfVariants:e.numberOfVariants}):e}function C(n,t){var s,l;if(((s=n==null?void 0:n.type)==null?void 0:s.toLowerCase())!=="order")return{success:!1,message:"invalid order"};let e=(l=n.behavior)==null?void 0:l.toLowerCase();switch(e===void 0&&(e="sequence"),e){case"sequence":return J(n,t);case"select":return G(n,t);case"shuffle":return H(n,t);default:return{success:!1,message:`Have not implemented behavior: ${e}`}}}function J(n,t){let e=[];for(let s of n.content){let l=s.type.toLowerCase();if(l==="page")e.push(s);else if(l==="order"){let o=C(s,t);if(o.success)e.push(...o.pages);else return o}else return{success:!1,message:"Unrecognized item in order."}}return{success:!0,pages:e}}function G(n,t){let e=n.numberToSelect,s=n.content.length;Number.isInteger(e)&&e>0||(e=1);let l=1;if(n.withReplacement||(l=e),l>s)return{success:!1,message:"Cannot select "+l+" components from only "+s};let o=n.selectWeights||[];if(!Array.isArray(o)||!o.every(r=>r>=0))return{success:!1,message:"Invalid selectWeights"};o=o.slice(0,s),o.length<s&&o.push(...Array(s-o.length).fill(1));let i=o.reduce((r,p)=>r+p);o=o.map(r=>r/i);let c=o.reduce((r,p,d)=>[...r,p+(r[d-1]||0)],[]),f=[...Array(c.length).keys()],a=[];for(let r=0;r<e;r++){let p=t(),d=-1,y=c.length-1;for(;d<y-1;){let h=Math.floor((d+y)/2);c[h]>p?y=h:d=h}a.push(n.content[f[y]]),!n.withReplacement&&r<e-1&&(o.splice(y,1),f.splice(y,1),i=o.reduce((h,v)=>h+v),o=o.map(h=>h/i),c=o.reduce((h,v,w)=>[...h,v+(h[w-1]||0)],[]))}let u=[];for(let r of a){let p=r.type.toLowerCase();if(p==="page")u.push(r);else if(p==="order"){let d=C(r);if(d.success)u.push(...d.pages);else return d}else return{success:!1,message:"Unrecognized item in order."}}return{success:!0,pages:u}}function H(n,t){let e=[...n.content];for(let l=n.content.length-1;l>0;l--){const o=t(),i=Math.floor(o*(l+1));[e[l],e[i]]=[e[i],e[l]]}let s=[];for(let l of e){let o=l.type.toLowerCase();if(o==="page")s.push(l);else if(o==="order"){let i=C(l,t);if(i.success)s.push(...i.pages);else return i}else return{success:!1,message:"Unrecognized item in order."}}return{success:!0,pages:s}}async function K(n){let t=[{}],e=P();for(let[s,l]of n.slice(0,n.length-1).entries()){let{fullSerializedComponents:o}=await L({contentIds:[l.cid],doenetMLs:[l.doenetML],componentInfoObjects:e}),i=o[0];x(i);let c=i[0].children,f=F(c),a=t[s];for(let u in a)u in f?f[u]+=a[u]:f[u]=a[u];t.push(f)}return t}export{_ as a,X as c,S as d,U as p,Y as r};
