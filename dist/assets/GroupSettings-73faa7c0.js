import{e as N,s as j,bl as q,v as L,r as b,g as f,w as v,o as V,a_ as J,a as l,j as a,_ as I,B as G,ar as z}from"./index-8f45050f.js";import{p as U}from"./index-c76324a2.js";import{C as Y}from"./CollapseSection-428ba864.js";function $(e,r){switch(r.type){case"mount":return{...r.payload};case"min":return{...e,min:r.payload.min>1?r.payload.min:1,max:e.max<r.payload.min?r.payload.min:e.max,pref:e.pref<r.payload.min?r.payload.min:e.pref};case"max":return{...e,min:e.min,max:e.min<=r.payload.max?r.payload.max:e.max,pref:e.pref<r.payload.max?r.payload.max:e.pref};case"pref":return{...e,pref:e.min<=r.payload.pref&&r.payload.pref<=e.max?r.payload.pref:e.pref};case"preAssigned":try{f.post("/api/updateGroupSettings.php",{...e,preAssigned:r.payload.preAssigned,doenetId:r.payload.doenetId})}catch(d){console.error(d)}return{...e,preAssigned:r.payload.preAssigned};case"isReleased":return{...e,isReleased:r.payload.isReleased};case"save":try{f.post("/api/updateGroupSettings.php",{...e,doenetId:r.payload.doenetId})}catch(d){console.error(d)}return e;default:throw new Error("Invaild groupSettings dispach")}}function S(e){for(var r=e.length,d,o;r;)o=Math.floor(Math.random()*r--),d=e[r],e[r]=e[o],e[o]=d;return e}const R=z({key:"csvGroups",default:{namesByGroup:[],emailsByGroup:[]}});function W(){const e=N(j("doenetId")),{emailsByGroup:r}=N(R(e)),d=q(R(e)),o=L(),[{min:w,max:A,pref:E,preAssigned:y,isReleased:O},t]=b.useReducer($,{min:0,max:0,pref:0,preAssigned:0,isReleased:0}),_=b.useCallback(async(n,c)=>{try{const{data:{entries:s}}=await f.get("/api/loadCollection.php",{params:{doenetId:n}});if((s==null?void 0:s.length)>0){const p=S(s),m=S([...c]);f.post("/api/assignCollection.php",{doenetId:n,groups:JSON.stringify(m),entries:JSON.stringify(p)}),t({type:"isReleased",payload:{isReleased:"1"}})}else o("Please add at least one entry to the collection before assigning",v.ERROR)}catch(s){console.error(s)}},[o]);b.useCallback(()=>{},[]);const k=V(({set:n})=>c=>{const s=new FileReader;s.onabort=()=>{},s.onerror=()=>{},s.onload=()=>{U(s.result,{comment:"#"},function(p,m){if(p)console.error(p),o(`CSV invalid – Error: ${p}`,v.ERROR);else{const g=m.shift(),C=g.indexOf("Email"),B=g.indexOf("Group Number"),P=g.indexOf("First Name"),M=g.indexOf("Last Name"),i={namesByGroup:[],emailsByGroup:[]};if(C===-1)o('File missing "Email" column header',v.ERROR);else if(B===-1)o('File missing "Group Number" column header',v.ERROR);else for(let u in m){let x=m[u],h=x[B]-1;i.emailsByGroup[h]||(i.emailsByGroup[h]=[],i.namesByGroup[h]=[]),i.emailsByGroup[h].push(x[C]),i.namesByGroup[h].push({firstName:x[P]??"",lastName:x[M]??""})}for(let u=0;u<i.emailsByGroup.length;u++)i.emailsByGroup[u]||(i.emailsByGroup[u]=[],i.namesByGroup[u]=[]);n(R(e),i)}})},s.readAsText(c[0])},[o,e]),{getRootProps:F,getInputProps:T,isDragActive:D}=J({onDrop:k});return b.useEffect(()=>{let n=!0;async function c(s){try{const p=await f.get("/api/loadGroupSettings.php",{params:{doenetId:s}});n&&t({type:"mount",payload:p.data})}catch(p){console.error(p)}}return e!==""&&c(e),()=>{n=!1,d()}},[e,d]),l("div",{children:[l("label",{children:["Pre-Assigned Groups:",a("input",{type:"checkbox",checked:y==="1",value:y==="1",onChange:n=>{t({type:"preAssigned",payload:{preAssigned:n.target.checked?"1":"0",doenetId:e}})}})]}),a("br",{}),y==="1"?l("div",{children:[l("div",{...F(),children:[a("input",{...T()}),D?a("p",{children:"Drop files here"}):a(I,{children:a(G,{value:"Upload CSV",width:"menu"})})]},"drop"),a("br",{}),l(Y,{title:"Formatting Instructions",collapsed:!0,children:[a("p",{children:"Your file needs to contain email address and group number columns. They can be in any order, but the headers are case sensitive."}),a("p",{children:"Name fields are displayed for convenience – only required data is used to assign the Collection"}),a("div",{children:a("b",{children:"First Name"})}),a("div",{children:a("b",{children:"Last Name"})}),a("div",{children:a("b",{children:"Email (required)"})}),a("div",{children:a("b",{children:"Group Number (required)"})}),a("p",{children:"NOTE: The parser will ignore columns which are not listed."})]})]}):l("div",{children:[l("label",{children:["Min Studnets:",a("input",{type:"number",value:w,onChange:n=>{t({type:"min",payload:{min:n.target.value}})}})]},"min"),a("br",{}),l("label",{children:["Max Students:",a("input",{type:"number",value:A,onChange:n=>{t({type:"max",payload:{max:n.target.value}})}})]},"max"),a("br",{}),l("label",{children:["Preferred Students:",a("input",{type:"number",value:E,onChange:n=>{t({type:"pref",payload:{pref:n.target.value}})}})]},"pref"),a("br",{})]}),a("br",{}),l(I,{vertical:!0,children:[y==="1"?null:a(G,{width:"menu",value:"Save",onClick:()=>{t({type:"save",payload:{doenetId:e}})}}),a(G,{alert:!0,disabled:O==="1",width:"menu",value:"Assign Collection",onClick:()=>{_(e,r)}})]})]})}export{R as csvGroups,W as default};
