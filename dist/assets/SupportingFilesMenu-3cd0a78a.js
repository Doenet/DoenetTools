import{v as oe,e as re,s as ne,l as pe,r as x,o as M,g as b,w as m,a_ as de,a as c,F as ue,j as t,_ as ce,B as ge,ar as he,as as K,aR as B,av as Q,H as q}from"./index-1e3edf2b.js";import{A as H}from"./ActionButtonGroup-fce51d51.js";import{C as me}from"./CollapseSection-90af4623.js";import{f as G}from"./index-47ca4f11.js";function L(d){var i=["Bytes","KB","MB","GB","TB"];if(d==0)return"0 Byte";var l=parseInt(Math.floor(Math.log(d)/Math.log(1024)));return Math.round(d/Math.pow(1024,l),2)+" "+i[l]}const J=he({key:"supportingFilesAndPermissionByDoenetId",default:K({key:"supportingFilesAndPermissionByDoenetId/Default",get:d=>async()=>{let{data:i}=await b.get("/api/loadSupportingFileInfo.php",{params:{doenetId:d}});return i}})}),A=K({get:d=>({get:i})=>i(J(d)),set:d=>({set:i},l)=>{i(J(d),l)}});function N({text:d,submit:i}){i||(i=()=>{});let[l,y]=x.useState(!1),[f,S]=x.useState(d),F=d;l||(F=f);let D={width:"110px",display:"inline-block",textOverflow:"ellipsis",whiteSpace:"nowrap"};return F===""&&(F=" *Required",D.border="solid 2px var(--mainRed)"),l?t("input",{autoFocus:!0,type:"text",style:{width:"116px"},value:f,onChange:v=>S(v.target.value),onBlur:v=>{y(!1),i(f)},onKeyDown:v=>{v.key==="Enter"&&(y(!1),i(f))}}):t("span",{style:D,onClick:()=>y(!0),children:F})}function we(d){const i=oe(),l=re(ne("doenetId")),[{canUpload:y,userQuotaBytesAvailable:f,supportingFiles:S,quotaBytes:F,canEditContent:D},v]=pe(A(l));let X=["text/csv","image/jpeg","image/png"],[V,$]=x.useState([]),w=x.useRef(0);const W=M(({set:a})=>async(r,o)=>{await b.get("/api/updateFileDescription.php",{params:{doenetId:l,cid:o,description:r}}),a(A(l),g=>{let n={...g},e=[...g.supportingFiles];return e.map((p,s)=>{p.cid===o&&(e[s]={...e[s]},e[s].description=r)}),n.supportingFiles=e,n})},[l]),T=M(({set:a})=>async(r,o)=>{await b.get("/api/updateFileAsFileName.php",{params:{doenetId:l,cid:o,asFileName:r}}),a(A(l),g=>{let n={...g},e=[...g.supportingFiles];return e.map((p,s)=>{p.cid===o&&(e[s]={...e[s]},e[s].asFileName=r)}),n.supportingFiles=e,n})},[l]),j=M(({set:a})=>async r=>{var o,g,n;try{let e=await b.get("/api/deleteFile.php",{params:{doenetId:l,cid:r}});if(e.status<300&&((o=e==null?void 0:e.data)!=null&&o.success)){i("File deleted.");let{userQuotaBytesAvailable:p}=e.data;a(A(l),s=>{let h={...s};return h.supportingFiles=s.supportingFiles.filter(u=>u.cid!==r),h.userQuotaBytesAvailable=p,h})}else if(((g=e==null?void 0:e.data)==null?void 0:g.success)==!1)i((n=e==null?void 0:e.data)==null?void 0:n.message,m.ERROR);else throw new Error(`response code: ${e.status}`)}catch(e){throw new Error(`Error deleting file ${e}`)}},[l]),Y=x.useCallback(a=>{let r=!0,o=0;a.map(e=>{X.includes(e.type)||(i(`File '${e.name}' of type '${e.type}' is not allowed. No files uploaded.`,m.ERROR),r=!1),o+=e.size});let g=L(o),n=L(o-f);o>f&&(i(`Upload size ${g} exceeds quota by ${n}. No files uploaded.`,m.ERROR),r=!1),w.current>0&&(i("Already uploading files.  Please wait before sending more.",m.ERROR),r=!1),a.map(e=>{e.size>=1e6&&(i(`File '${e.name}' is larger than 1MB. No files uploaded.`,m.ERROR),r=!1)}),r&&(w.current=a.length,a.map(e=>{let p={fileName:e.name,size:e.size,progressPercent:0};$(s=>[...s,p])}),a.map((e,p)=>{const s=new FileReader;s.readAsDataURL(e),s.onabort=()=>{},s.onerror=()=>{},s.onload=()=>{const h=new FormData;h.append("file",e),h.append("doenetId",l),b.post("/api/upload.php",h,{onUploadProgress:u=>{const R=u.lengthComputable?u.total:u.target.getResponseHeader("content-length")||u.target.getResponseHeader("x-decompressed-content-length");if(R!==null){let I=Math.round(u.loaded*100/R);$(O=>{let C=[...O];return C[p].progressPercent=I,C})}}}).then(({data:u})=>{w.current=w.current-1,w.current<1&&$([]);let{success:R,fileName:I,cid:O,asFileName:C,width:ie,height:se,msg:_,userQuotaBytesAvailable:le}=u;_&&(R?i(_,m.INFO):i(_,m.ERROR)),R&&v(z=>{let E={...z},k=[...z.supportingFiles];return k.push({cid:O,fileName:I,fileType:e.type,width:ie,height:se,description:"",asFileName:C}),E.supportingFiles=k,E.userQuotaBytesAvailable=le,E})})}}))},[]),{getRootProps:Z,getInputProps:ee,isDragActive:te}=de({onDrop:Y});let ae=V.map(a=>c("div",{children:[a.fileName," - ",a.progressPercent,"%"]},`${a.fileName}`)),U=null;y&&(U=c(ue,{children:[c("div",{children:[f,"/",F," Bytes"]}),c("div",{...Z(),children:[t("input",{...ee()}),te?t("p",{children:"Drop the files here"}):t(ce,{vertical:!0,children:t(ge,{width:"menu",value:"Upload files"})})]},"drop"),t(me,{title:"Accepted File Types",collapsed:!0,children:c("div",{children:[t("b",{children:"Image"}),".jpg .png .csv"]})}),ae]}));let P=[];return S.map(({cid:a,fileName:r,fileType:o,width:g,description:n,asFileName:e})=>{let p="Error",s=`doenet:cid=${a}`;if(o==="image/jpeg"||o==="image/png"){p=`<image source='${s}' description='${n}' asfilename='${e}' width='${g}' mimeType='${o}' />`;let h={};P.push(c("div",{children:[c("div",{children:[t("span",{style:{width:"116px"},children:"asFileName:"}),t(N,{text:e,submit:u=>{T(u,a)}})]}),c("div",{style:h,children:[t("span",{style:{width:"116px"},children:"description:"}),t(N,{text:n,submit:u=>{W(u,a)}})]}),t("div",{children:c(H,{width:"menu",children:[y?t(B,{alert:!0,value:"Delete",onClick:()=>{j(a)}}):null,t(Q.CopyToClipboard,{onCopy:()=>i("Code copied to clipboard!",m.SUCCESS),text:p,children:t(B,{disabled:n=="",icon:t(q,{icon:G}),value:"Copy Code"})})]})}),t("hr",{})]},`${a}`))}else o==="text/csv"&&(p=`<dataFrame source='${s}' hasHeader="true" />`,P.push(c("div",{children:[t("div",{children:c("span",{style:{width:"116px"},children:["fileName:"," ",t(N,{text:e,submit:h=>{T(h,a)}})]})}),t("div",{children:c(H,{width:"menu",children:[y?t(B,{alert:!0,value:"Delete",onClick:()=>{j(a)}}):null,t(Q.CopyToClipboard,{onCopy:()=>i("Code copied to clipboard!",m.SUCCESS),text:p,children:t(B,{icon:t(q,{icon:G}),value:"Copy Code"})})]})}),t("hr",{})]},`${a}`)))}),c("div",{children:[U,t("br",{}),P]})}export{we as default};
