import{e as x,s as J,b as re,a7 as de,v as ce,o as B,g as b,w as g,au as T,a4 as k,aT as E,at as le,j as c,a as P,F as fe,B as O,ap as X}from"./index-a1cd8b25.js";import{i as w,f as K,b as _,C as me,R as De}from"./CourseToolHandler-ceca1b11.js";import{R as Q}from"./RelatedItems-9e7662ee.js";import"./index-47ca4f11.js";import"./index.esm-1c81c270.js";/* empty css             */const A=X({key:"currentDraftSelectedAtom",default:!0}),j=X({key:"selectedVersionIdAtom",default:null});function we(Y){var q;console.log(">>>===VersionHistory");const R=x(J("doenetId")),Z=decodeURIComponent(x(J("path"))),S=re(w(R)),ee=x(de),te=x(j),h=ce(),V=x(A),[F,L,U]=Z.split(":"),ne=B(({set:t,snapshot:l})=>async({doenetId:e,versionId:u,driveId:f,folderId:r,itemId:d})=>{const{data:o}=await b.get("/api/releaseVersion.php",{params:{doenetId:e,versionId:u}}),{success:m,message:y,isReleased:D,title:I}=o;let p="Retracted";D==="1"&&(p="Released"),m?h(`"${I}" is ${p}`,g.SUCCESS):h(y,g.ERROR),t(w(e),a=>{let n={...a},i=[...a.named];for(const[v,N]of i.entries()){let C={...N};N.versionId===u?(C.isReleased=D,i[v]=C):(C.isReleased="0",i[v]=C)}return n.named=i,n}),t(K({driveId:f,folderId:r}),a=>{let n={...a};for(let i of n.contentIds.defaultOrder)if(n.contentsDictionary[i].doenetId===e){d=i;break}return n.contentsDictionary={...a.contentsDictionary},n.contentsDictionary[d]={...a.contentsDictionary[d]},n.contentsDictionary[d].isReleased=D,n.contentsDictionaryByDoenetId={...a.contentsDictionaryByDoenetId},n.contentsDictionaryByDoenetId[e]={...a.contentsDictionaryByDoenetId[e]},n.contentsDictionaryByDoenetId[e].isReleased=D,n})}),se=B(({snapshot:t,set:l})=>async({doenetId:e,versionId:u})=>{const f=await t.getPromise(w(e));let r={...f.draft};r.isDraft="0";const d=`Save (current) ${f.named.length+1}`;r.title=d,r.timestamp=_();let o={};for(let I of f.named)I.versionId===u&&(o={...I});const m=T();o.versionId=m,o.isDraft="1",o.isNamed="0",o.isReleased="0";let y={...f};y.named=[r,...f.named],y.draft=o,l(w(e),y),l(A,!0),l(j,m);let D={...o,isSetAsCurrent:"1",newDraftVersionId:m,newDraftContentId:o.cid,doenetId:e,newTitle:d};b.post("/api/saveNewVersion.php",D)}),ie=B(({snapshot:t,set:l})=>async e=>{const u=await t.getPromise(k),f=_(),r=await E(u),d=T(),o=await t.getPromise(w(e));let m={...o},D={title:`Save ${o.named.length+1}`,versionId:d,timestamp:f,isReleased:"0",isDraft:"0",isNamed:"1",cid:r},I={...D,doenetML:u,doenetId:e};m.named=[D,...o.named],l(w(e),m),b.post("/api/saveNewVersion.php",I).then(p=>{var a,n;(a=p==null?void 0:p.data)!=null&&a.success?h("New Version Saved!",g.SUCCESS):(h("Version NOT Saved!",g.ERROR),console.error((n=p.data)==null?void 0:n.message))}).catch(p=>{h("Version NOT Saved!",g.ERROR)})}),oe=B(({snapshot:t,set:l})=>async({doenetId:e,driveId:u,folderId:f,itemId:r})=>{const d=await t.getPromise(k),o=le(new Date),m=await E(d),y=T(),{data:D}=await b.post("/api/releaseDraft.php",{doenetId:e,doenetML:d,timestamp:o,versionId:y}),{success:I,message:p,title:a}=D;I?h(`"${a}" is Released.`,g.SUCCESS):h(p,g.ERROR),l(w(e),n=>{let i={...n},v=[...n.named];for(const[C,ae]of v.entries()){let G={...ae};G.isReleased="0",v[C]=G}let N={title:a,versionId:y,timestamp:o,isReleased:"1",isDraft:"0",isNamed:"1",cid:m};return v.unshift(N),i.named=v,i}),l(K({driveId:u,folderId:f}),n=>{let i={...n};for(let v of i.contentIds.defaultOrder)if(i.contentsDictionary[v].doenetId===e){r=v;break}return i.contentsDictionary={...n.contentsDictionary},i.contentsDictionary[r]={...n.contentsDictionary[r]},i.contentsDictionary[r].isReleased="1",i.contentsDictionaryByDoenetId={...n.contentsDictionaryByDoenetId},i.contentsDictionaryByDoenetId[e]={...n.contentsDictionaryByDoenetId[e]},i.contentsDictionaryByDoenetId[e].isReleased="1",i})}),$=B(({snapshot:t,set:l})=>async({doenetId:e,versionId:u,isCurrentDraft:f})=>{l(j,u),l(A,f);const r=await t.getPromise(w(e));let d={...r},o=r.draft.cid;if(!f&&await t.getPromise(A)){const y=await t.getPromise(k),D=await E(y);if(D!==o){let I={...r.draft};I.cid=D,I.timestamp=_(),d.draft=I,l(w(e),d);let p={...I,doenetML:y,doenetId:e};try{const{data:a}=await b.post("/api/saveNewVersion.php",p);a.success||console.log("ERROR",a.message)}catch(a){console.log("ERROR",a)}}}d.draft.cid;for(let m of d.named)if(m.versionId===u){m.cid;break}});if(ee!==R)return c("div",{style:Y.style});if(!((q=S==null?void 0:S.contents)!=null&&q.named))return null;let M=[],H={},z=te;for(let t of S.contents.named){H[t.versionId]=t;let l=!1;t.versionId===z&&(l=!0);let e="";t.isReleased==="1"&&(e="(Released)"),M.push(P("option",{value:t.versionId,selected:l,children:[e," ",t.title]},`option${t.versionId}`))}const s=H[z];let W="Release";return(s==null?void 0:s.isReleased)==="1"&&(W="Retract"),P(fe,{children:[c("div",{style:{padding:"6px 0px 6px 0px"},children:c(Q,{size:"2",width:"menu",onChange:t=>{$({doenetId:R,versionId:t.target.value,isCurrentDraft:!0})},options:c("option",{value:S.contents.draft.versionId,selected:V,children:"Current Draft"})})}),c("div",{style:{margin:"0px 0px 6px 0px"},children:c(O,{disabled:!V,width:"menu",value:"Save Version",onClick:()=>ie(R)})}),c("div",{style:{margin:"6px 0px 6px 0px"},children:c(O,{disabled:!V,width:"menu",value:"Release Current",onClick:()=>{oe({doenetId:R,driveId:F,folderId:L,itemId:U})}})}),c("div",{children:"History"}),c(Q,{size:"8",width:"menu",onChange:t=>{$({doenetId:R,versionId:t.target.value,isCurrentDraft:!1})},options:M}),P("div",{children:["Name: ",s==null?void 0:s.title]}),c(me,{disabled:V,cid:s==null?void 0:s.cid,doenetId:R}),c("div",{children:c(De,{disabled:V,doenetId:R,title:s==null?void 0:s.title,versionId:s==null?void 0:s.versionId},s==null?void 0:s.versionId)}),c("div",{children:c(O,{disabled:V,onClick:()=>se({doenetId:R,versionId:s.versionId}),value:"Set As Current"})}),c("div",{children:c(O,{disabled:V,onClick:()=>ne({doenetId:R,versionId:s.versionId,driveId:F,folderId:L,itemId:U}),value:W})})]})}export{A as currentDraftSelectedAtom,we as default,j as selectedVersionIdAtom};
