import{v as oe,e as re,s as ne,l as pe,r as x,o as M,g as b,w as f,aY as de,a as u,F as ue,j as t,_ as ce,B as ge,ap as he,aq as K,aP as B,at as Q,H as q}from"./index-66847aab.js";import{A as H}from"./ActionButtonGroup-e22e5a7e.js";import{C as me}from"./CollapseSection-c5ae55cc.js";import{f as G}from"./index-47ca4f11.js";function L(n){var i=["Bytes","KB","MB","GB","TB"];if(n==0)return"0 Byte";var l=parseInt(Math.floor(Math.log(n)/Math.log(1024)));return Math.round(n/Math.pow(1024,l),2)+" "+i[l]}const J=he({key:"supportingFilesAndPermissionByDoenetId",default:K({key:"supportingFilesAndPermissionByDoenetId/Default",get:n=>async()=>{let{data:i}=await b.get("/api/loadSupportingFileInfo.php",{params:{doenetId:n}});return i}})}),A=K({get:n=>({get:i})=>i(J(n)),set:n=>({set:i},l)=>{i(J(n),l)}});function N({text:n,submit:i}){i||(i=()=>{});let[l,F]=x.useState(!1),[y,S]=x.useState(n),w=n;l||(w=y);let $={width:"110px",display:"inline-block",textOverflow:"ellipsis",whiteSpace:"nowrap"};return w===""&&(w=" *Required",$.border="solid 2px var(--mainRed)"),l?t("input",{autoFocus:!0,type:"text",style:{width:"116px"},value:y,onChange:v=>S(v.target.value),onBlur:v=>{F(!1),i(y)},onKeyDown:v=>{v.key==="Enter"&&(F(!1),i(y))}}):t("span",{style:$,onClick:()=>F(!0),children:w})}function ve(n){const i=oe(),l=re(ne("doenetId")),[{canUpload:F,userQuotaBytesAvailable:y,supportingFiles:S,quotaBytes:w,canEditContent:$},v]=pe(A(l));let X=["text/csv","image/jpeg","image/png"],[Y,D]=x.useState([]),R=x.useRef(0);const V=M(({set:a})=>async(r,o)=>{await b.get("/api/updateFileDescription.php",{params:{doenetId:l,cid:o,description:r}}),a(A(l),c=>{let g={...c},e=[...c.supportingFiles];return e.map((p,s)=>{p.cid===o&&(e[s]={...e[s]},e[s].description=r)}),g.supportingFiles=e,g})},[l]),T=M(({set:a})=>async(r,o)=>{await b.get("/api/updateFileAsFileName.php",{params:{doenetId:l,cid:o,asFileName:r}}),a(A(l),c=>{let g={...c},e=[...c.supportingFiles];return e.map((p,s)=>{p.cid===o&&(e[s]={...e[s]},e[s].asFileName=r)}),g.supportingFiles=e,g})},[l]),j=M(({set:a})=>async r=>{var o,c,g;try{let e=await b.get("/api/deleteFile.php",{params:{doenetId:l,cid:r}});if(e.status<300&&((o=e==null?void 0:e.data)!=null&&o.success)){i("File deleted.");let{userQuotaBytesAvailable:p}=e.data;a(A(l),s=>{let h={...s};return h.supportingFiles=s.supportingFiles.filter(d=>d.cid!==r),h.userQuotaBytesAvailable=p,h})}else if(((c=e==null?void 0:e.data)==null?void 0:c.success)==!1)i((g=e==null?void 0:e.data)==null?void 0:g.message,f.ERROR);else throw new Error(`response code: ${e.status}`)}catch(e){throw new Error(`Error deleting file ${e}`)}},[l]),W=x.useCallback(a=>{let r=!0,o=0;a.map(e=>{X.includes(e.type)||(i(`File '${e.name}' of type '${e.type}' is not allowed. No files uploaded.`,f.ERROR),r=!1),o+=e.size});let c=L(o),g=L(o-y);o>y&&(i(`Upload size ${c} exceeds quota by ${g}. No files uploaded.`,f.ERROR),r=!1),R.current>0&&(i("Already uploading files.  Please wait before sending more.",f.ERROR),r=!1),a.map(e=>{e.size>=1e6&&(i(`File '${e.name}' is larger than 1MB. No files uploaded.`,f.ERROR),r=!1)}),r&&(R.current=a.length,a.map(e=>{let p={fileName:e.name,size:e.size,progressPercent:0};D(s=>[...s,p])}),a.map((e,p)=>{const s=new FileReader;s.readAsDataURL(e),s.onabort=()=>{},s.onerror=()=>{},s.onload=()=>{const h=new FormData;h.append("file",e),h.append("doenetId",l),b.post("/api/upload.php",h,{onUploadProgress:d=>{const m=d.lengthComputable?d.total:d.target.getResponseHeader("content-length")||d.target.getResponseHeader("x-decompressed-content-length");if(m!==null){let I=Math.round(d.loaded*100/m);D(O=>{let C=[...O];return C[p].progressPercent=I,C})}}}).then(({data:d})=>{R.current=R.current-1,R.current<1&&D([]);let{success:m,fileName:I,cid:O,asFileName:C,width:ie,height:se,msg:E,userQuotaBytesAvailable:le}=d;E&&(m?i(E,f.INFO):i(E,f.ERROR)),m&&v(z=>{let _={...z},k=[...z.supportingFiles];return k.push({cid:O,fileName:I,fileType:e.type,width:ie,height:se,description:"",asFileName:C}),_.supportingFiles=k,_.userQuotaBytesAvailable=le,_})})}}))},[]),{getRootProps:Z,getInputProps:ee,isDragActive:te}=de({onDrop:W});let ae=Y.map(a=>u("div",{children:[a.fileName," - ",a.progressPercent,"%"]},`${a.fileName}`)),U=null;F&&(U=u(ue,{children:[u("div",{children:[y,"/",w," Bytes"]}),u("div",{...Z(),children:[t("input",{...ee()}),te?t("p",{children:"Drop the files here"}):t(ce,{vertical:!0,children:t(ge,{width:"menu",value:"Upload files"})})]},"drop"),t(me,{title:"Accepted File Types",collapsed:!0,children:u("div",{children:[t("b",{children:"Image"}),".jpg .png .csv"]})}),ae]}));let P=[];return S.map(({cid:a,fileName:r,fileType:o,width:c,height:g,description:e,asFileName:p})=>{let s="Error",h=`doenet:cid=${a}`;if(o==="image/jpeg"||o==="image/png"){s=`<image source='${h}' description='${e}' asfilename='${p}' width='${c}' height='${g}' mimeType='${o}' />`;let d={};P.push(u("div",{children:[u("div",{children:[t("span",{style:{width:"116px"},children:"asFileName:"}),t(N,{text:p,submit:m=>{T(m,a)}})]}),u("div",{style:d,children:[t("span",{style:{width:"116px"},children:"description:"}),t(N,{text:e,submit:m=>{V(m,a)}})]}),t("div",{children:u(H,{width:"menu",children:[F?t(B,{alert:!0,value:"Delete",onClick:()=>{j(a)}}):null,t(Q.CopyToClipboard,{onCopy:()=>i("Code copied to clipboard!",f.SUCCESS),text:s,children:t(B,{disabled:e=="",icon:t(q,{icon:G}),value:"Copy Code"})})]})}),t("hr",{})]},`${a}`))}else o==="text/csv"&&(s=`<dataFrame source='${h}' hasHeader="true" />`,P.push(u("div",{children:[t("div",{children:u("span",{style:{width:"116px"},children:["fileName:"," ",t(N,{text:p,submit:d=>{T(d,a)}})]})}),t("div",{children:u(H,{width:"menu",children:[F?t(B,{alert:!0,value:"Delete",onClick:()=>{j(a)}}):null,t(Q.CopyToClipboard,{onCopy:()=>i("Code copied to clipboard!",f.SUCCESS),text:s,children:t(B,{icon:t(q,{icon:G}),value:"Copy Code"})})]})}),t("hr",{})]},`${a}`)))}),u("div",{children:[U,t("br",{}),P]})}export{ve as default};
