import{r as f,a as C,j as s,H as He,aP as Ge,e as Q,s as We,q as Ye,R as Qe,y as Je,l as F,p as ce,O as Ke,P as Xe,A as me,u as Ze,f as et,b as tt,c as at,o as j,g as p,F as J,B as K,D as st,ap as B,aQ as nt,_ as it,aR as rt,am as lt,an as ot,aS as dt}from"./index-b99cb1f6.js";import{e as ut}from"./RoleDropdown-f3dc3e4f.js";import"./DropdownMenu-493863fd.js";function pe(l){const[c,u]=f.useState("flex");var g={padding:"10px",display:`${c}`,alignItems:"center"},r={flexGrow:"1",lineHeight:"1.4",fontFamily:"Open Sans",fontSize:"16px"},h={background:"none",border:"0px",marginLeft:"5px",padding:"0px",value:"Label:",fontFamily:"Open Sans",fontSize:"14px",cursor:"pointer"},e={};switch(l.type){case"ERROR":e.backgroundColor="var(--mainRed)",e.color="var(--canvas)",h.color="var(--canvas)";break;case"ALERT":e.backgroundColor="var(--lightYellow)";break;case"ACTION":e.backgroundColor="var(--lightBlue)";break;case"SUCCESS":e.backgroundColor="var(--lightGreen)";break;default:e.backgroundColor="var(--mainGreen)";break}function b(){u("none")}return l.allowClose&&(e.closeButton=s("button",{"aria-label":"Close banner",style:h,onClick:()=>{b()},children:s(He,{icon:Ge})})),C("div",{"aria-labelledby":"banner-text",children:[s("div",{style:e,children:C("div",{style:g,children:[s("div",{style:r,id:"banner-text",children:l.value}),e.closeButton]})}),s("div",{style:{padding:"5px"}})]})}const ge=B({key:"currentAttemptNumber",default:null}),ct=B({key:"creditAchievedAtom",default:{creditByItem:[],creditForAttempt:0,creditForAssignment:0,totalPointsOrPercent:0}}),fe=B({key:"activityStatusAtom",default:{currentPage:0,activityAttemptNumberSetUp:0,itemWeights:[]}}),he=B({key:"numberOfAttemptsAllowedAdjustment",default:0}),mt=B({key:"cidChanged",default:!1});function X({previousVariants:l,allPossibleVariants:c,individualize:u,userId:g,doenetId:r,attemptNumber:h}){let e=[],b=(h-1)%c.length,w=[];if(b>0)for(let m=h-b;m<h;m++)if(l[m-1])w.push(l[m-1]);else{let D=X({previousVariants:l.slice(0,m-1),allPossibleVariants:c,individualize:u,userId:g,doenetId:r,attemptNumber:m});l[m-1]=D,w.push(D)}for(let m of c)w.includes(m)||e.push(m);let _=r+"|"+h;u&&(_+="|"+g);let V=new nt(_);const $=Math.floor(V()*e.length);return e[$]}function vt(){const l=Q(We("doenetId")),c=Q(Ye),u=Qe(Je);let[g,r]=f.useState("Initializing"),[h,e]=f.useState("");const[b,w]=F(ge),[_,V]=F(mt),[{requestedVariantIndex:$,attemptNumber:x,showCorrectness:m,paginate:D,showFinishButton:ve,showFeedback:Ae,showHints:be,autoSubmit:we,cid:ye,doenetId:A,solutionDisplayMode:Ce,baseNumberOfAttemptsAllowed:xe},E]=f.useState({}),[Se,Ne]=F(he),[Ie,Z]=f.useState(!1),[Ve,ee]=F(ce);let L=f.useRef([]),M=f.useRef(null),k=f.useRef(null);Ke(l),Xe(c);const S=Q(ut(c));let[v,ke]=F(me(l)),z=v.label,te=Ze(),{search:Pe,hash:ae}=te,se=et();f.useEffect(()=>{const n=document.title;return z&&(document.title=`${z} - Doenet`),()=>{document.title=n}},[z]),f.useEffect(()=>{Object.keys(v).length>0&&Object.keys(S).length>0&&Re(l,v)},[v,l,S]);const Oe=tt(at);M.current=Oe.contents.userId;const Re=j(({snapshot:n,set:o})=>async(i,{type:a,timeLimit:d,assignedDate:O,dueDate:ne,showCorrectness:R,showCreditAchievedMenu:N,paginate:ie,showFinishButton:re,showFeedback:le,showHints:oe,autoSubmit:de,showSolution:Le,proctorMakesAvailable:Me,numberOfAttemptsAllowed:ue})=>{if(a===void 0)return;let U=[];d===null&&U.push("TimerMenu"),(!R||!N||S.canViewUnassignedContent!=="0")&&U.push("CreditAchieved"),u(U);let H="button";if(!Le&&S.canViewUnassignedContent==="0"&&(H="none"),Me){const{page:Y}=await n.getPromise(ce);if(Y!=="exam"){r("Problem"),e("Assignment only available in a proctored setting.");return}else{const{data:Ue}=await p.get("/api/checkSEBheaders.php",{params:{doenetId:i}});if(Number(Ue.legitAccessKey)!==1){r("Problem"),e("Browser not configured properly to take an exam.");return}}}let T=null,t=await p.get("/api/getCidForAssignment.php",{params:{doenetId:i,latestAttemptOverrides:!0}});if(t.data.success)if(t.data.cid)T=t.data.cid;else{r("Problem"),e("Assignment is not assigned.");return}else{r("Problem"),e(`Error loading assignment: ${t.data.message}`);return}if(V(t.data.cidChanged),t=await p.get("/api/loadTakenVariants.php",{params:{doenetId:i}}),!t.data.success){r("Problem"),t.data.message?e(`Could not load assignment: ${t.data.message}`):e(`Could not load assignment: ${t.data}`);return}let I=t.data.variants.map(Number),y=Math.max(...t.data.attemptNumbers.map(Number)),G=!1;if(y<1?(y=1,G=!0):t.data.variants[t.data.variants.length-1]===null&&(G=!0),o(ge,y),t=await p.get("/api/loadAttemptsAllowedAdjustment.php",{params:{doenetId:i}}),!t.data.success){r("Problem"),t.data.message?e(`Could not load assignment: ${t.data.message}`):e(`Could not load assignment: ${t.data}`);return}let ze=Number(t.data.numberOfAttemptsAllowedAdjustment);o(he,ze);let W=await pt(T);if(!W.success){E({requestedVariantIndex:0,attemptNumber:y,showCorrectness:R,paginate:ie,showFinishButton:re,showFeedback:le,showHints:oe,autoSubmit:de,cid:T,doenetId:i,solutionDisplayMode:H,baseNumberOfAttemptsAllowed:ue}),r("Problem"),e(W.message);return}if(L.current=[...Array(W.numVariants).keys()].map(Y=>Y+1),G){if(t=await p.get("/api/getIndividualizeForAssignment.php",{params:{doenetId:i}}),!t.data.success){r("Problem"),t.data.message?e(`Could not load assignment: ${t.data.message}`):e(`Could not load assignment: ${t.data}`);return}k.current=t.data.individualize==="1",I=I.slice(0,y-1),I.push(X({previousVariants:I,allPossibleVariants:L.current,individualize:k.current,userId:M.current,doenetId:i,attemptNumber:y}))}let qe=I[I.length-1];E({requestedVariantIndex:qe,attemptNumber:y,showCorrectness:R,paginate:ie,showFinishButton:re,showFeedback:le,showHints:oe,autoSubmit:de,cid:T,doenetId:i,solutionDisplayMode:H,baseNumberOfAttemptsAllowed:ue}),r("Ready")},[u,S]),Fe=j(({snapshot:n,set:o})=>async()=>{if(o(me(A),a=>{let d={...a};return d.completed=!0,d.completedDate=new Date,d}),(await p.get("/api/saveCompleted.php",{params:{activityId:A,isCompleted:!0}})).data.success){const{itemWeights:a}=await n.getPromise(fe);ee(d=>({page:d.page,tool:"endExam",view:"",params:{doenetId:A,attemptNumber:x,itemWeights:a.join(",")}}))}},[A,x,ee]);async function Be(n,o){ae&&ae!=="#page1"&&se(Pe,{replace:!0});let i=null,a=await p.get("/api/getCidForAssignment.php",{params:{doenetId:o,latestAttemptOverrides:!1}});if(a.data.success)if(a.data.cid)i=a.data.cid;else{r("Problem"),e("Assignment is not assigned.");return}else{r("Problem"),e(`Error loading assignment: ${a.data.message}`);return}console.log(`retrieved cid: ${i}`);const{data:d}=await p.get("/api/loadTakenVariants.php",{params:{doenetId:o}});if(!d.success){r("Problem"),d.message?e(`Could not load assignment: ${d.message}`):e(`Could not load assignment: ${d}`);return}let O=d.variants.map(Number).slice(0,n-1);if(k.current===null){if(a=await p.get("/api/getIndividualizeForAssignment.php",{params:{doenetId:o}}),!a.data.success){r("Problem"),a.data.message?e(`Could not load assignment: ${a.data.message}`):e(`Could not load assignment: ${a.data}`);return}k.current=a.data.individualize==="1",r("Ready")}O.push(X({previousVariants:O,allPossibleVariants:L.current,individualize:k.current,userId:M.current,doenetId:o,attemptNumber:n}));let ne=O[O.length-1];E(R=>{let N={...R};return N.attemptNumber=n,N.requestedVariantIndex=ne,N.cid=i,N}),V(!1)}const _e=j(({set:n})=>async({creditByItem:o,creditForAssignment:i,creditForAttempt:a,totalPointsOrPercent:d})=>{n(ct,{creditByItem:o,creditForAssignment:i,creditForAttempt:a,totalPointsOrPercent:d})}),De=j(({set:n})=>async({itemWeights:o,currentPage:i,activityAttemptNumberSetUp:a})=>{n(fe,{itemWeights:o,currentPage:i,activityAttemptNumberSetUp:a})});function Te(n){}async function je(){let n=await p.post("/api/incrementAttemptsAllowedIfCidChanged.php",{doenetId:A});n.data.cidChanged&&(Ne(Number(n.data.newNumberOfAttemptsAllowedAdjustment)),w(o=>o+1))}if(l==="")return null;if(c==="__not_found__")return s("h1",{children:"Content not found or no permission to view content"});if(g==="Initializing")return null;if(b>x)return Be(b,l),null;if(g==="Problem")return s("h1",{children:h});if(!(v!=null&&v.canViewAfterCompleted)&&v.completed)return Number(v.numberOfAttemptsAllowed)+Number(Se)>x?s(J,{children:C("div",{style:{margin:"15px"},children:[s("h1",{children:"Assessment Complete"}),s("p",{children:"You have completed this assessment. Would you like to begin another attempt?"}),s("p",{children:s(K,{value:"Begin New Attempt",onClick:async()=>{const{data:o}=await p.get("/api/saveCompleted.php",{params:{doenetId:A}});o.success?(w(i=>i+1),ke(i=>{let a={...i};return a.completed=!1,a})):(r("Problem"),e("Internal Error"))}})})]})}):s(J,{children:C("div",{style:{margin:"15px"},children:[s("h1",{children:"Assessment Complete"}),s("p",{children:"You have already completed this assessment and no additional attempts are available."})]})});let q=null;if(_)if(Ie){let n=null;xe>1&&(n=" and the number of available attempts"),q=s(pe,{type:"ACTION",value:C("div",{style:{border:"var(--mainBorder)",borderRadius:"var(--mainBorderRadius)",padding:"5px",margin:"5px",display:"flex",flexFlow:"column wrap"},children:["A new version of this activity is available. Do you want to start a new attempt using the new version? (This will reset the activity",n,".)",s("div",{style:{display:"flex",justifyContent:"center",padding:"5px"},children:C(it,{children:[s(K,{onClick:je,dataTest:"ConfirmNewVersion",value:"Yes"}),s(K,{onClick:()=>Z(!1),dataTest:"CancelNewVersion",value:"No",alert:!0})]})})]})})}else q=s(pe,{type:"ACTION",value:s("div",{style:{marginLeft:"1px",marginRight:"5px"},children:s(rt,{onClick:()=>Z(!0),dataTest:"NewVersionAvailable",value:"New version available!"})})});const P=S.canViewUnassignedContent==="0",$e={loadActivityState:"/api/loadActivityState.php",saveActivityState:"/api/saveActivityState.php",initAssignmentAttempt:"/api/initAssignmentAttempt.php",recordEvent:"/api/recordEvent.php",loadPageState:"/api/loadPageState.php",savePageState:"/api/savePageState.php",saveCreditForItem:"/api/saveCreditForItem.php",reportSolutionViewed:"/api/reportSolutionViewed.php"},Ee=document.getElementById("mainPanel");return C(J,{children:[q,s(st,{cid:ye,activityId:A,flags:{showCorrectness:m,readOnly:!1,solutionDisplayMode:Ce,showFeedback:Ae,showHints:be,autoSubmit:we,allowLoadState:P,allowSaveState:P,allowLocalState:P,allowSaveSubmissions:P,allowSaveEvents:P},attemptNumber:x,requestedVariantIndex:$,updateCreditAchievedCallback:_e,updateActivityStatusCallback:De,updateAttemptNumber:w,pageChangedCallback:Te,paginate:D,location:te,navigate:se,showFinishButton:ve,cidChangedCallback:()=>V(!0),setActivityAsCompleted:Fe,idsIncludeActivityId:!1,linkSettings:{viewURL:Ve.page==="placementexam"?"/course?tool=exam":"/course?tool=assignment",editURL:"/public?tool=editor",useQueryParameters:!0},apiURLs:$e,scrollableContainer:Ee},`activityViewer${A}`)]})}async function pt(l){let c;try{c=await lt(l)}catch{return{success:!1,message:"Could not retrieve file"}}let u=await ot(c,l);if(u.errors.length>0)return{success:!1,message:u.errors[0].message};try{u=await dt(u.activityJSON)}catch(g){return{success:!1,message:g.message}}return{success:!0,numVariants:u.numVariants}}export{fe as activityStatusAtom,mt as cidChangedAtom,ct as creditAchievedAtom,ge as currentAttemptNumber,vt as default,he as numberOfAttemptsAllowedAdjustmentAtom};
