import{k as te,bv as k,av as re,bn as ie,r as o,bo as T,j as w,a as ne}from"./index-c9d6e71c.js";import{BoardContext as oe,IMAGE_LAYER_OFFSET as $}from"./graph-c6f702c2.js";import{s as ae}from"./css-14ccef8c.js";import{V as se}from"./visibility-sensor-935bf1b4.js";async function le(n,m){try{return await ce(n)}catch{}if(!m){let{data:b}=await te.get("/api/getMimeType.php",{params:{cid:n}});m=b["mime-type"]}return ue(n,m)}async function ce(n){let m=new AbortController,b=m.signal,p=setTimeout(()=>{m.abort()},1e3);try{let e=await fetch(`https://${n}.ipfs.dweb.link/`,{signal:b});if(clearTimeout(p),e.ok){let h=await e.blob();if(await k(await h.arrayBuffer())===n){let S=URL.createObjectURL(h);return{mediaBlob:h,mediaURL:S}}else return Promise.reject(new Error("cid mismatch"))}else return Promise.reject(new Error(`cid not found: ${n}`))}catch{return Promise.reject(new Error(`cid not found: ${n}`))}}async function ue(n,m){try{let b=fe(m),p=await fetch(`/media/${n}.${b}`);if(p.ok){let e=await p.blob();if(await k(await e.arrayBuffer())===n){let R=URL.createObjectURL(e);return{mediaBlob:e,mediaURL:R}}else return Promise.reject(new Error("cid mismatch"))}else return Promise.reject(new Error(`cid not found: ${n}`))}catch{return Promise.reject(new Error(`cid not found: ${n}`))}}function fe(n){return n==="image/png"?"png":n==="image/jpeg"?"jpg":n==="text/csv"?"csv":"txt"}const ge=re.memo(function(m){var D;let{name:b,id:p,SVs:e,actions:h,callAction:R}=ie(m,!1),[S,W]=o.useState(null),i=o.useRef(null),_=o.useRef(null);const c=o.useContext(oe);let A=o.useRef(!1),U=o.useRef(!1),j=o.useRef(!1),C=o.useRef(null),F=o.useRef(null),Y=o.useRef(null),B=o.useRef(null),x=o.useRef(null),v=o.useRef(null),V=o.useRef(null),M=o.useRef(e.rotate);const P=(e.cid?S:e.source)||"";let H=s=>{R({action:h.recordVisibilityChange,args:{isVisible:s}})};o.useEffect(()=>()=>{R({action:h.recordVisibilityChange,args:{isVisible:!1}})},[]),o.useEffect(()=>{e.cid&&le(e.cid,e.mimeType).then(s=>{W(s.mediaURL)}).catch(s=>{})},[]);function q(){var z;let s=!e.draggable||e.fixed,l={visible:!e.hidden,fixed:s,layer:10*e.layer+$,highlight:!s},g;try{let d=T.fromAst(e.anchor),y=[d.get_component(0).evaluate_to_constant(),d.get_component(1).evaluate_to_constant()];Number.isFinite(y[0])||(y[0]=0,l.visible=!1),Number.isFinite(y[1])||(y[1]=0,l.visible=!1),g=c.create("point",y,{visible:!1})}catch{l.visible=!1,g=c.create("point",[0,0],{visible:!1})}l.anchor=g;let f=((z=e.widthForGraph)==null?void 0:z.size)||1,u=f/(e.aspectRatio||1);Number.isFinite(f)&&Number.isFinite(u)||(f=0,u=0);let r;e.positionFromAnchor==="center"?r=[-f/2,-u/2]:e.positionFromAnchor==="lowerleft"?r=[-f,-u]:e.positionFromAnchor==="lowerright"?r=[0,-u]:e.positionFromAnchor==="upperleft"?r=[-f,0]:e.positionFromAnchor==="upperright"?r=[0,0]:e.positionFromAnchor==="bottom"?r=[-f/2,-u]:e.positionFromAnchor==="top"?r=[-f/2,0]:e.positionFromAnchor==="right"?r=[0,-u/2]:r=[-f,-u/2],v.current=r;let t=c.create("image",[P,r,[f,u]],l);var O=c.create("transform",[function(){return-t.X()-t.W()*.5},function(){return-t.Y()-t.H()*.5}],{type:"translate"}),a=c.create("transform",[function(){return t.X()+t.W()*.5},function(){return t.Y()+t.H()*.5}],{type:"translate"}),L=c.create("transform",[e.rotate],{type:"rotate"});O.bindTo(t),L.bindTo(t),a.bindTo(t),V.current=L,M.current=e.rotate,t.on("down",function(d){A.current=[d.x,d.y],U.current=[...g.coords.scrCoords],j.current=!1}),t.on("up",function(d){j.current&&R({action:h.moveImage,args:{x:C.current,y:F.current}}),j.current=!1}),t.on("drag",function(d){var y=c.origin.scrCoords;let[G,N,I,J]=c.getBoundingBox(),K=G+.01*(I-G)-v.current[0]-x.current[0],Q=I-.01*(I-G)-v.current[0],Z=J+.01*(N-J)-v.current[1]-x.current[1],ee=N-.01*(N-J)-v.current[1];C.current=(U.current[1]+d.x-A.current[0]-y[1])/c.unitX,C.current=Math.min(Q,Math.max(K,C.current)),F.current=(y[2]-(U.current[2]+d.y-A.current[1]))/c.unitY,F.current=Math.min(ee,Math.max(Z,F.current)),R({action:h.moveImage,args:{x:C.current,y:F.current,transient:!0,skippable:!0}}),t.relativeCoords.setCoordinates(JXG.COORDS_BY_USER,v.current),g.coords.setCoordinates(JXG.COORDS_BY_USER,Y.current),(Math.abs(d.x-A.current[0])>.1||Math.abs(d.y-A.current[1])>.1)&&(j.current=!0)}),i.current=t,_.current=g,B.current=e.positionFromAnchor,x.current=[f,u],i.current.fullUpdate()}if(c){let s;try{let l=T.fromAst(e.anchor);s=[l.get_component(0).evaluate_to_constant(),l.get_component(1).evaluate_to_constant()]}catch{s=[NaN,NaN]}if(Y.current=s,i.current===null){if(e.cid&&!S)return null;q()}else{_.current.coords.setCoordinates(JXG.COORDS_BY_USER,s);let l=!e.hidden;if(Number.isFinite(s[0])&&Number.isFinite(s[1])){let a=i.current.visProp.visible!==l;i.current.visProp.visible=l,i.current.visPropCalc.visible=l,a&&i.current.setAttribute({visible:l})}else i.current.visProp.visible=!1,i.current.visPropCalc.visible=!1;let g=10*e.layer+$;i.current.visProp.layer!==g&&i.current.setAttribute({layer:g});let u=!e.draggable||e.fixed;i.current.visProp.highlight=!u,i.current.visProp.fixed=u,i.current.needsUpdate=!0;let r=((D=e.widthForGraph)==null?void 0:D.size)||1,t=r/(e.aspectRatio||1);Number.isFinite(r)&&Number.isFinite(t)||(r=0,t=0);let O=r!==x.current[0]||t!==x.current[1];if(O&&(i.current.setSize(r,t),x.current=[r,t]),e.rotate!=M.current&&(V.current.setMatrix(c,"rotate",[e.rotate]),M.current=e.rotate),e.positionFromAnchor!==B.current||O){let a;e.positionFromAnchor==="center"?a=[-r/2,-t/2]:e.positionFromAnchor==="lowerleft"?a=[-r,-t]:e.positionFromAnchor==="lowerright"?a=[0,-t]:e.positionFromAnchor==="upperleft"?a=[-r,0]:e.positionFromAnchor==="upperright"?a=[0,0]:e.positionFromAnchor==="bottom"?a=[-r/2,-t]:e.positionFromAnchor==="top"?a=[-r/2,0]:e.positionFromAnchor==="right"?a=[0,-t/2]:a=[-r,-t/2],i.current.relativeCoords.setCoordinates(JXG.COORDS_BY_USER,a),B.current=e.positionFromAnchor,v.current=a,i.current.fullUpdate()}else i.current.relativeCoords.setCoordinates(JXG.COORDS_BY_USER,v.current),i.current.update();_.current.needsUpdate=!0,_.current.update(),c.updateRenderer()}return w("a",{name:p})}if(e.hidden)return null;let X={};e.displayMode==="inline"?X={display:"inline-block",verticalAlign:"middle",margin:"12px 0"}:X={display:"flex",justifyContent:e.horizontalAlign,margin:"12px 0"};let E={maxWidth:"100%",width:ae(e.width)};return e.aspectRatio>0&&(E.aspectRatio=String(e.aspectRatio)),P||(E.border="var(--mainBorder)"),w(se,{partialVisibility:!0,onChange:H,children:ne("div",{style:X,children:[w("a",{name:p}),P?w("img",{id:p,src:P,style:E,alt:e.description}):w("div",{id:p,style:E,children:e.description})]})})});export{ge as default};
