import{y as ut,R as G,p as dt,r,g as We,ab as ft,u as gt,e as mt,ad as Be,v as vt,ae as Le,af as K,k as p,z as N,a as A,j as f,P as It,ag as Y,ah as je,ac as yt,ai as Je,i as St,aj as ht,B as T}from"./index-7c464f87.js";import{p as ve,c as Ct}from"./activityUtils-1ee2a5a3.js";import{V as wt}from"./visibility-sensor-82f19459.js";import{A as bt}from"./ActionButton-0f7ae8d8.js";import{B as At}from"./ButtonGroup-bc0b5002.js";const Ie=Y({key:"saveStateToDBTimerIdAtom",default:null}),xt=Y({key:"currentPageAtom",default:0}),Pt=Y({key:"activityAttemptNumberSetUpAtom",default:0}),Et=Y({key:"itemWeightsAtom",default:[]});function Ot(t){var Fe;const x=ut(),Me=G(dt),[ye,I]=r.useState(null),[{cidFromProps:h,activityDefinitionFromProps:C,attemptNumber:g,requestedVariantIndex:L},ze]=r.useState({cidFromProps:null,activityDefinitionFromProps:null,attemptNumber:null,requestedVariantIndex:null}),k=r.useRef(null);k.current=g;const[m,H]=r.useState(null),O=r.useRef(null);O.current=m;const Q=r.useRef(null),[P,X]=r.useState(null),[V,Z]=r.useState(null),ee=r.useRef(null);ee.current=V;const[j,w]=r.useState("initial"),Se=r.useRef(null);Se.current=j;const te=r.useRef(!0),[_e,he]=r.useState(!1),[J,ae]=r.useState(null),[ne,Ue]=r.useState(t.flags),[c,E]=r.useState(0),R=G(xt),b=r.useRef(c);b.current=c;const Ce=G(Pt),[u,ie]=r.useState(0),[M,re]=r.useState(null),[se,oe]=We(Et),$=r.useRef([]),ce=r.useRef(null),le=r.useRef(null),ue=r.useRef(!1),we=G(Ie),[qe,Ge]=We(ft),y=r.useRef(null),z=r.useRef(null),be=r.useRef(null),Ae=r.useRef(null),[S,de]=r.useState({pageIsVisible:[],pageIsActive:[],pageCoreWorker:[],waitingForPagesCore:null}),[Ke,Ye]=r.useState([]),fe=r.useRef(!1),F=r.useRef(null),ge=r.useRef(!1),D=r.useRef(null);let v=gt(),d=v.hash;const W=r.useRef({}),_=r.useRef(null),xe=r.useRef(!1),[He,Pe]=r.useState(!1),[Ee,Qe]=r.useState(!1);let Xe=mt();r.useEffect(()=>()=>{U({overrideThrottle:!0}),xe.current=!0},[]),r.useEffect(()=>{let e={...t.flags};t.userId?(e.allowLocalState=!1,e.allowSaveState=!1):e.allowSaveState&&(e.allowLoadState=!0),Ue(e)},[t.userId,t.flags]),r.useEffect(()=>{window.returnActivityData=function(){return{activityDefinition:P,requestedVariantIndex:L,variantIndex:V,cid:m,order:J,currentPage:c,nPages:u,variantsByPage:M,itemWeights:se}}},[P,L,V,m,J,c,u,M,se]),r.useEffect(()=>{if(F.current){let e=F.current.parentNode.id==="mainPanel"?F.current.parentNode:window;Ge(e),!t.paginate&&u>1&&e.addEventListener("scroll",a=>{if(ge.current)ge.current=!1;else{let i;for(let s=0;s<u-1;s++){let n=document.getElementById(`page${s+1}`);if(n){let{bottom:o}=n.getBoundingClientRect();o<50?i=s+2:i||(i=1)}}i&&i!==b.current&&(E(i),R(i))}})}},[F.current,u]),r.useEffect(()=>{var e;(e=t.pageChangedCallback)==null||e.call(t,c)},[c]),r.useEffect(()=>{if(d&&u){let e=d.match(/^#page(\d+)/);if(e){let a=Math.max(1,Math.min(u,e[1]));a!==c&&(E(a),R(a))}}},[d,u]),r.useEffect(()=>{var e,a;if(c>0&&u>1){if(Number((e=d==null?void 0:d.match(/^#page(\d+)/))==null?void 0:e[1])!==c){let s=`#page${c}`,n={replace:!0};t.paginate||(n.state={doNotScroll:!0}),Xe(v.search+s,n)}D.current&&((a=document.getElementById(D.current))==null||a.scrollIntoView(),D.current=null)}},[c,u]),r.useEffect(()=>{var e;fe.current&&!t.paginate&&(d!=null&&d.match(/^#page(\d+)$/))&&(ge.current=!0,(e=document.getElementById(Be(d.slice(1))))==null||e.scrollIntoView())},[fe.current]),r.useEffect(()=>{var a,i,s,n,o;let e=!1;if(_.current!==v.key&&(((a=v.state)==null?void 0:a.previousScrollPosition)!==void 0&&_.current&&(W.current[_.current].lastScrollPosition=v.state.previousScrollPosition),W.current[v.key]&&(e=!0,((i=W.current[v.key])==null?void 0:i.lastScrollPosition)!==void 0&&qe.scroll({top:W.current[v.key].lastScrollPosition})),W.current[v.key]={...v},_.current=v.key),D.current=null,!((s=v.state)!=null&&s.doNotScroll)&&(v.key==="default"||!e)){let l=Be(d.slice(1));t.paginate&&d.match(/^#page(\d+)$/)&&(l="activityTop"),t.paginate&&Number((n=d.match(/^#page(\d+)/))==null?void 0:n[1])!==c?D.current=l:(o=document.getElementById(l))==null||o.scrollIntoView()}},[v]);const Ze=vt(({snapshot:e})=>async()=>await e.getPromise(Ie),[Ie]);function Re({changedOnDevice:e,newCid:a,newAttemptNumber:i}){console.log("resetActivity",e,a,i),i!==g?t.updateAttemptNumber?(x("Reverted activity as attempt number changed on other device",N.ERROR),t.updateAttemptNumber(i)):(t.setIsInErrorState&&t.setIsInErrorState(!0),I("how to reset attempt number when not given updateAttemptNumber function?")):a!==m&&(t.setIsInErrorState&&t.setIsInErrorState(!0),I("Content changed unexpectedly!"))}function et(){C?h?je(JSON.stringify(C)).then(e=>{if(e===h){H(h),Q.current=C;let a=ve(C);a.success?(X(a.activityJSON),w("continue")):(t.setIsInErrorState&&t.setIsInErrorState(!0),I(a.message))}else t.setIsInErrorState&&t.setIsInErrorState(!0),I(`activity definition did not match specified cid: ${h}`)}):je(JSON.stringify(C)).then(e=>{H(e),Q.current=C;let a=ve(C);a.success?(X(a.activityJSON),w("continue")):(t.setIsInErrorState&&t.setIsInErrorState(!0),I(a.message))}):yt(h,"doenet").then(e=>{H(h),Q.current=e;let a=ve(e);a.success?(X(a.activityJSON),w("continue")):(t.setIsInErrorState&&t.setIsInErrorState(!0),I(a.message))}).catch(e=>{t.setIsInErrorState&&t.setIsInErrorState(!0),I(`activity definition not found for cid: ${h}`)})}async function tt(){let e=!1,a,i,s=!1;if(t.flags.allowLocalState){let n;try{n=await Je(`${t.doenetId}|${g}|${m}`)}catch{}if(n){if(t.flags.allowSaveState){let l=await at(n);if(l.changedOnDevice){if(Number(l.newAttemptNumber)!==g){Re({changedOnDevice:l.changedOnDevice,newCid:l.newCid,newAttemptNumber:Number(l.newAttemptNumber)});return}else l.newCid!==m&&(t.setIsInErrorState&&t.setIsInErrorState(!0),I("content changed unexpectedly!"));n=l.newLocalInfo}}ce.current=n.saveId,d!=null&&d.match(/^#page(\d+)/)||(E(n.activityState.currentPage),R(n.activityState.currentPage));let o=n.activityInfo;i=n.variantIndex,Z(i),ie(o.orderWithCids.length),ae(o.orderWithCids),re(o.variantsByPage),oe(o.itemWeights),a=o.itemWeights,$.current=o.previousComponentTypeCounts||[],y.current=o,z.current=JSON.stringify(y.current),e=!0}}if(!e){const n={params:{cid:m,attemptNumber:g,doenetId:t.doenetId,userId:t.userId,allowLoadState:t.flags.allowLoadState}};let o;try{if(o=await p.get("/api/loadActivityState.php",n),!o.data.success&&t.flags.allowLoadState){t.setIsInErrorState&&t.setIsInErrorState(!0),I(`Error loading activity state: ${o.data.message}`);return}}catch(l){if(t.flags.allowLoadState){t.setIsInErrorState&&t.setIsInErrorState(!0),I(`Error loading activity state: ${l.message}`);return}}if(o.data.loadedState){let l=JSON.parse(o.data.activityInfo),De=JSON.parse(o.data.activityState);d!=null&&d.match(/^#page(\d+)/)||(E(De.currentPage),R(De.currentPage)),i=o.data.variantIndex,Z(i),ie(l.orderWithCids.length),ae(l.orderWithCids),re(l.variantsByPage),oe(l.itemWeights),a=l.itemWeights,$.current=l.previousComponentTypeCounts||[],y.current=l,z.current=JSON.stringify(y.current)}else{s=!0,d!=null&&d.match(/^#page(\d+)/)||(E(1),R(1));let l;if(l=await Ct({activityDefinition:P,requestedVariantIndex:L}),!l.success){t.setIsInErrorState&&t.setIsInErrorState(!0),I(`Error initializing activity state: ${l.message}`);return}i=l.variantIndex,Z(i),ie(l.order.length),ae(l.order),re(l.variantsByPage),oe(l.itemWeights),a=l.itemWeights,$.current=l.previousComponentTypeCounts||[],y.current=l.activityInfo,z.current=JSON.stringify(y.current)}}return{newItemWeights:a,newVariantIndex:i,loadedFromInitialState:s}}async function at(e){let a=await Je(`${t.doenetId}|${g}|${m}|ServerSaveId`),i={cid:m,activityInfo:JSON.stringify(e.activityInfo),activityState:JSON.stringify(e.activityState),variantIndex:e.variantIndex,attemptNumber:g,doenetId:t.doenetId,saveId:e.saveId,serverSaveId:a,updateDataOnContentChange:t.updateDataOnContentChange},s;try{console.log("first one saveActivityState activityStateToBeSavedToDatabase",i),s=await p.post("/api/saveActivityState.php",i)}catch{return{localInfo:e,cid:m,attemptNumber:g}}s.data.cidChanged===!0&&t.cidChangedCallback();let n=s.data;if(!n.success)return{localInfo:e,cid:m,attemptNumber:g};if(await K(`${t.doenetId}|${g}|${m}|ServerSaveId`,n.saveId),n.stateOverwritten){let o={activityState:JSON.parse(n.activityState),activityInfo:JSON.parse(n.activityInfo),saveId:n.saveId,variantIndex:n.variantIndex};return await K(`${t.doenetId}|${n.attemptNumber}|${n.cid}`,o),{changedOnDevice:n.device,newLocalInfo:o,newCid:n.cid,newAttemptNumber:n.attemptNumber}}return{localInfo:e,cid:m,attemptNumber:g}}async function U({overrideThrottle:e=!1,overrideStage:a=!1}={}){if(!t.flags.allowSaveState&&!t.flags.allowLocalState||Se.current!=="saving"&&!a||!e&&b.current===be.current||e&&b.current===Ae.current)return;be.current=b.current;let i=Le();t.flags.allowLocalState&&await K(`${t.doenetId}|${k.current}|${O.current}`,{activityInfo:y.current,activityState:{currentPage:b.current},saveId:i,variantIndex:ee.current}),t.flags.allowSaveState&&(le.current={cid:O.current,activityInfo:z.current,activityState:JSON.stringify({currentPage:b.current}),variantIndex:ee.current,attemptNumber:k.current,doenetId:t.doenetId,saveId:i,serverSaveId:ce.current,updateDataOnContentChange:t.updateDataOnContentChange},ue.current=!0,await pe(e))}async function pe(e){if(!ue.current)return;let a=await Ze();if(a!==null)if(e)clearTimeout(a);else return;ue.current=!1,Ae.current=b.current;let i=setTimeout(()=>{we(null),pe()},6e4);we(i);let s;try{console.log("activity state params",le.current),s=await p.post("/api/saveActivityState.php",le.current)}catch{console.log("sending toast: Error synchronizing data.  Changes not saved to the server."),x("Error synchronizing data.  Changes not saved to the server.",N.ERROR);return}if(console.log("result from saving activity to database:",s.data),s.status===null){console.log("sending toast: Error synchronizing data.  Changes not saved to the server.  Are you connected to the internet?"),x("Error synchronizing data.  Changes not saved to the server.  Are you connected to the internet?",N.ERROR);return}let n=s.data;if(!n.success){console.log(`sending toast: ${n.message}`),x(n.message,N.ERROR);return}if(ce.current=n.saveId,t.flags.allowLocalState&&await K(`${t.doenetId}|${k.current}|${O.current}|ServerSaveId`,n.saveId),n.stateOverwritten){if(k.current!==Number(n.attemptNumber))Re({changedOnDevice:n.device,newCid:n.cid,newAttemptNumber:Number(n.attemptNumber)});else if(O.current!==n.cid){t.setIsInErrorState&&t.setIsInErrorState(!0),I("Content changed unexpectedly!");return}}}async function nt(e){if(ne.allowSaveSubmissions)try{let a=await p.post("/api/initAssignmentAttempt.php",{doenetId:t.doenetId,weights:e,attemptNumber:g});a.status===null?x("Could not initialize assignment tables.  Are you connected to the internet?",N.ERROR):a.data.success||x(`Could not initialize assignment tables: ${a.data.message}.`,N.ERROR)}catch(a){x(`Could not initialize assignment tables: ${a.message}.`,N.ERROR)}}async function it(){j!=="saving"&&!te.current&&w("saving");try{(await p.get("/api/checkForChangedAssignment.php",{params:{currentCid:m,doenetId:t.doenetId}})).data.cidChanged===!0&&t.cidChangedCallback()}catch{}xe.current&&await U({overrideThrottle:!0,overrideStage:!0})}function Ne(){E(a=>Math.min(u,a+1)),R(a=>Math.min(u,a+1));let e={verb:"interacted",object:{objectType:"button",objectname:"next page button"},result:{newPage:Math.min(u,c+1)},context:{oldPage:c}};ke(e)}function Te(){E(a=>Math.max(1,a-1)),R(a=>Math.max(1,a-1));let e={verb:"interacted",object:{objectType:"button",objectname:"previous page button"},result:{newPage:Math.max(1,c-1)},context:{oldPage:c}};ke(e)}function ke(e){if(!ne.allowSaveEvents)return;const a={doenetId:t.doenetId,activityCid:m,attemptNumber:g,activityVariantIndex:V,timestamp:new Date().toISOString().slice(0,19).replace("T"," "),version:"0.1.1",verb:e.verb,object:JSON.stringify(e.object),result:JSON.stringify(e.result),context:JSON.stringify(e.context)};p.post("/api/recordEvent.php",a).then(i=>{}).catch(i=>{console.error(`Error saving event: ${i.message}`)})}function rt(e,a){t.paginate||de(i=>{let s={...i},n=[...s.pageIsVisible];if(n[a]=e,s.pageIsVisible=n,!e&&s.pageIsActive[a]){let o=[...s.pageIsActive];o[a]=!1,s.pageIsActive=o,s.waitingForPagesCore===a&&(s.waitingForPagesCore=null)}return s})}function st(e,a){de(i=>{let s={...i};s.waitingForPagesCore===e&&(s.waitingForPagesCore=null);let n=[...s.pageCoreWorker];return n[e]=a,s.pageCoreWorker=n,s})}function ot(e){let a;Ye(i=>(a=[...i],a[e]=!0,a)),(a==null?void 0:a.length)===u&&a.every(i=>i)&&(fe.current=!0)}async function ct(){Qe(!0);let e=[];for(let i of S.pageCoreWorker)if(i){let s=Le(),n;e.push(new Promise((o,l)=>{n=o})),i.onmessage=function(o){o.data.messageType==="resolveAction"&&o.data.args.actionId===s?i.postMessage({messageType:"terminate"}):o.data.messageType==="terminated"&&n()},i.postMessage({messageType:"submitAllAnswers",args:{actionId:s}})}await Promise.all(e),await U({overrideThrottle:!0}),y.canViewAfterCompleted,(await p.get("/api/saveCompleted.php",{params:{doenetId:t.doenetId,isCompleted:!0}})).data.success&&(t==null||t.setActivityAsCompleted(),Me(i=>({page:i.page,tool:"endExam",view:"",params:{doenetId:t.doenetId,attemptNumber:g,itemWeights:se.join(",")}})))}if(ye!==null)return A("div",{style:{fontSize:"1.3em",marginLeft:"20px",marginTop:"20px"},children:[f("span",{style:{fontSize:"1em",color:"#C1292E"},children:f(St,{icon:ht})})," ",ye]});if(S.waitingForPagesCore===null&&c){for(let e of[c-1,...Array(u).keys()])if((S.pageIsVisible[e]||c===e+1)&&!S.pageIsActive[e]){let i=!S.pageCoreWorker[e];if(de(s=>{let n={...s},o=[...n.pageIsActive];return o[e]=!0,n.pageIsActive=o,n.pageCoreWorker[e]||(n.waitingForPagesCore=e),n}),i)break}}let B=t.attemptNumber;B===void 0&&(B=1);let q=t.requestedVariantIndex;if(q===void 0&&(q=B),C!==t.activityDefinition||h!==t.cid||B!==g||L!==q)return te.current=!0,ze({activityDefinitionFromProps:t.activityDefinition,cidFromProps:t.cid,attemptNumber:B,requestedVariantIndex:q}),w("recalcParams"),he(!0),null;if(j==="wait")return null;if(j==="recalcParams")return w("wait"),et(),null;if(((Fe=P==null?void 0:P.type)==null?void 0:Fe.toLowerCase())!=="activity")return t.setIsInErrorState&&t.setIsInErrorState(!0),I("Invalid activity definition: type is not activity"),null;if(_e)return he(!1),Ce(0),$.current=[],w("wait"),tt().then(async e=>{var a;e&&(e.loadedFromInitialState&&await nt(e.newItemWeights),w("continue"),Ce(g),(a=t.generatedVariantCallback)==null||a.call(t,e.newVariantIndex,y.current.numberOfVariants)),te.current=!1}),null;U();let lt=f("h1",{children:P.title}),Oe=[];if(J&&M)for(let[e,a]of J.entries()){let i=!1;t.paginate?(e===c-1||S.pageCoreWorker[c-1]&&e===c||S.pageCoreWorker[c-1]&&(c===u||S.pageCoreWorker[c])&&e===c-2)&&(i=!0):i=S.pageIsActive[e];let s=u>1?`page${e+1}`:"",n=f(It,{userId:t.userId,doenetId:t.doenetId,activityCid:m,cid:a.cid,doenetML:a.doenetML,pageNumber:(e+1).toString(),previousComponentTypeCounts:$.current[e],pageIsActive:i,pageIsCurrent:e===c-1,itemNumber:e+1,attemptNumber:g,forceDisable:t.forceDisable,forceShowCorrectness:t.forceShowCorrectness,forceShowSolution:t.forceShowSolution,forceUnsuppressCheckwork:t.forceUnsuppressCheckwork,flags:ne,activityVariantIndex:V,requestedVariantIndex:M[e],unbundledCore:t.unbundledCore,updateCreditAchievedCallback:t.updateCreditAchievedCallback,setIsInErrorState:t.setIsInErrorState,updateAttemptNumber:t.updateAttemptNumber,saveStateCallback:it,updateDataOnContentChange:t.updateDataOnContentChange,coreCreatedCallback:o=>st(e,o),renderersInitializedCallback:()=>ot(e),hideWhenNotCurrent:t.paginate,prefixForIds:s});t.paginate||(n=f(wt,{partialVisibility:!0,offset:{top:-200,bottom:-200},requireContentsSize:!1,onChange:o=>rt(o,e),children:f("div",{children:n})})),Oe.push(f("div",{id:`page${e+1}`,children:n},`page${e+1}`))}let Ve=null,$e=null;t.paginate&&u>1&&(Ve=A("div",{style:{display:"flex",alignItems:"center",marginLeft:"5px"},children:[f(T,{dataTest:"previous",disabled:c===1,onClick:Te,value:"Previous page"}),A("p",{style:{margin:"5px"},children:[" Page ",c," of ",u," "]}),f(T,{dataTest:"next",disabled:c===u,onClick:Ne,value:"Next page"})]}),Ke[c-1]&&($e=A("div",{style:{display:"flex",alignItems:"center",marginLeft:"5px"},children:[f(T,{dataTest:"previous-bottom",disabled:c===1,onClick:Te,value:"Previous page"}),A("p",{style:{margin:"5px"},children:[" Page ",c," of ",u," "]}),f(T,{dataTest:"next-bottom",disabled:c===u,onClick:Ne,value:"Next page"})]})));let me=null;return t.showFinishButton&&(He?me=A("div",{style:{marginLeft:"1px",marginRight:"5px",marginBottom:"5px",marginTop:"80px",border:"var(--mainBorder)",borderRadius:"var(--mainBorderRadius)",padding:"5px",display:"flex",flexFlow:"column wrap"},children:[f("div",{style:{display:"flex",justifyContent:"center",padding:"5px"},children:"Are you sure you want to finish this assessment?"}),f("div",{style:{display:"flex",justifyContent:"center",padding:"5px"},children:A(At,{children:[f(T,{onClick:ct,dataTest:"ConfirmFinishAssessment",value:"Yes",disabled:Ee}),f(T,{onClick:()=>Pe(!1),dataTest:"CancelFinishAssessment",value:"No",alert:!0,disabled:Ee})]})})]}):me=f("div",{style:{marginLeft:"1px",marginRight:"5px",marginBottom:"5px",marginTop:"80px"},children:f("div",{"data-test":"centerone",style:{display:"flex",justifyContent:"center"},children:f("div",{style:{width:"240px"},children:f(bt,{onClick:()=>Pe(!0),"data-test":"FinishAssessmentPrompt",value:"Finish assessment"})})})})),A("div",{style:{paddingBottom:"50vh"},id:"activityTop",ref:F,children:[Ve,lt,Oe,$e,me]})}export{Ot as A,Pt as a,xt as c,Et as i,Ie as s};
