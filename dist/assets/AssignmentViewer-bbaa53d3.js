import{r as f,a as y,j as a,i as Me,a8 as Ee,l as Q,m as ze,w as Le,R as qe,E as Ge,g as $,v as D,Q as He,S as Ue,G as de,u as Ye,e as We,b as Je,c as Ke,p as Qe,k as g,F as X,B as Z,ah as j,ad as Xe}from"./index-404de25b.js";import{s as ue,A as Ze}from"./ActivityViewer-11598c9b.js";import{a as et,p as tt,d as at}from"./activityUtils-ef441747.js";import{A as st}from"./ActionButton-28acc886.js";import{B as nt}from"./ButtonGroup-c43b7e60.js";import{e as it}from"./RoleDropdown-445d5eea.js";import"./visibility-sensor-6e6ccf6e.js";import"./DropdownMenu-c371d5a2.js";import"./setPrototypeOf-51e8cf87.js";function ce(r){const[u,d]=f.useState("flex");var m={padding:"10px",display:`${u}`,alignItems:"center"},i={flexGrow:"1",lineHeight:"1.4",fontFamily:"Open Sans",fontSize:"16px"},h={background:"none",border:"0px",marginLeft:"5px",padding:"0px",value:"Label:",fontFamily:"Open Sans",fontSize:"14px",cursor:"pointer"},e={};switch(r.type){case"ERROR":e.backgroundColor="var(--mainRed)",e.color="var(--canvas)",h.color="var(--canvas)";break;case"ALERT":e.backgroundColor="var(--lightYellow)";break;case"ACTION":e.backgroundColor="var(--lightBlue)";break;case"SUCCESS":e.backgroundColor="var(--lightGreen)";break;default:e.backgroundColor="var(--mainGreen)";break}function A(){d("none")}return r.allowClose&&(e.closeButton=a("button",{"aria-label":"Close banner",style:h,onClick:()=>{A()},children:a(Me,{icon:Ee})})),y("div",{"aria-labelledby":"banner-text",children:[a("div",{style:e,children:y("div",{style:m,children:[a("div",{style:i,id:"banner-text",children:r.value}),e.closeButton]})}),a("div",{style:{padding:"5px"}})]})}const me=j({key:"currentAttemptNumber",default:null}),rt=j({key:"creditAchievedAtom",default:{creditByItem:[],creditForAttempt:0,creditForAssignment:0,totalPointsOrPercent:0}}),pe=j({key:"numberOfAttemptsAllowedAdjustment",default:0}),lt=j({key:"cidChanged",default:!1});function ee({previousVariants:r,allPossibleVariants:u,individualize:d,userId:m,doenetId:i,attemptNumber:h}){let e=[],A=(h-1)%u.length,v=[];if(A>0)for(let c=h-A;c<h;c++)if(r[c-1])v.push(r[c-1]);else{let T=ee({previousVariants:r.slice(0,c-1),allPossibleVariants:u,individualize:d,userId:m,doenetId:i,attemptNumber:c});r[c-1]=T,v.push(T)}for(let c of u)v.includes(c)||e.push(c);let B=i+"|"+h;d&&(B+="|"+m);let k=new et(B);const M=Math.floor(k()*e.length);return e[M]}function At(){const r=Q(ze("doenetId")),u=Q(Le),d=qe(Ge);let[m,i]=f.useState("Initializing"),[h,e]=f.useState("");const[A,v]=$(me),[B,k]=$(lt),[{requestedVariantIndex:M,attemptNumber:F,showCorrectness:c,paginate:T,showFinishButton:ge,showFeedback:fe,showHints:he,autoSubmit:be,cid:Ae,doenetId:x,solutionDisplayMode:ve,baseNumberOfAttemptsAllowed:we},E]=f.useState({}),[Ce,ye]=$(pe),[xe,te]=f.useState(!1);let z=f.useRef([]),L=f.useRef(null),O=f.useRef(null);const Ne=D(({snapshot:s})=>async()=>await s.getPromise(ue),[ue]);He(r),Ue(u);const N=Q(it(u));let[b,Ve]=$(de(r)),q=b.label,{search:Ie,hash:ae}=Ye(),ke=We();f.useEffect(()=>{const s=document.title;return q&&(document.title=`${q} - Doenet`),()=>{document.title=s}},[q]),f.useEffect(()=>{Object.keys(b).length>0&&Object.keys(N).length>0&&Se(r,b)},[b,r,N]);const Oe=Je(Ke);L.current=Oe.contents.userId;const Se=D(({snapshot:s,set:l})=>async(n,{type:p,timeLimit:o,assignedDate:V,dueDate:R,showCorrectness:P,showCreditAchievedMenu:H,paginate:w,showFinishButton:se,showFeedback:ne,showHints:ie,autoSubmit:re,showSolution:_e,proctorMakesAvailable:$e,numberOfAttemptsAllowed:le})=>{if(p===void 0)return;let U=[];o===null&&U.push("TimerMenu"),(!P||!H||N.canViewUnassignedContent!=="0")&&U.push("CreditAchieved"),d(U);let Y="button";if(!_e&&N.canViewUnassignedContent==="0"&&(Y="none"),$e){const{page:K}=await s.getPromise(Qe);if(K!=="exam"){i("Problem"),e("Assignment only available in a proctored setting.");return}else{const{data:je}=await g.get("/api/checkSEBheaders.php",{params:{doenetId:n}});if(Number(je.legitAccessKey)!==1){i("Problem"),e("Browser not configured properly to take an exam.");return}}}let _=null,t=await g.get("/api/getCidForAssignment.php",{params:{doenetId:n,latestAttemptOverrides:!0}});if(t.data.success)if(t.data.cid)_=t.data.cid;else{i("Problem"),e("Assignment is not assigned.");return}else{i("Problem"),e(`Error loading assignment: ${t.data.message}`);return}if(k(t.data.cidChanged),t=await g.get("/api/loadTakenVariants.php",{params:{doenetId:n}}),!t.data.success){i("Problem"),t.data.message?e(`Could not load assignment: ${t.data.message}`):e(`Could not load assignment: ${t.data}`);return}let I=t.data.variants.map(Number),C=Math.max(...t.data.attemptNumbers.map(Number)),W=!1;if(C<1?(C=1,W=!0):t.data.variants[t.data.variants.length-1]===null&&(W=!0),l(me,C),t=await g.get("/api/loadAttemptsAllowedAdjustment.php",{params:{doenetId:n}}),!t.data.success){i("Problem"),t.data.message?e(`Could not load assignment: ${t.data.message}`):e(`Could not load assignment: ${t.data}`);return}let De=Number(t.data.numberOfAttemptsAllowedAdjustment);l(pe,De);let J=await ot(_);if(!J.success){E({requestedVariantIndex:0,attemptNumber:C,showCorrectness:P,paginate:w,showFinishButton:se,showFeedback:ne,showHints:ie,autoSubmit:re,cid:_,doenetId:n,solutionDisplayMode:Y,baseNumberOfAttemptsAllowed:le}),i("Problem"),e(J.message);return}if(z.current=[...Array(J.numberOfVariants).keys()].map(K=>K+1),W){if(t=await g.get("/api/getIndividualizeForAssignment.php",{params:{doenetId:n}}),!t.data.success){i("Problem"),t.data.message?e(`Could not load assignment: ${t.data.message}`):e(`Could not load assignment: ${t.data}`);return}O.current=t.data.individualize==="1",I=I.slice(0,C-1),I.push(ee({previousVariants:I,allPossibleVariants:z.current,individualize:O.current,userId:L.current,doenetId:n,attemptNumber:C}))}let oe=I[I.length-1];console.log(`requestedVariantIndex: ${oe}`),E({requestedVariantIndex:oe,attemptNumber:C,showCorrectness:P,paginate:w,showFinishButton:se,showFeedback:ne,showHints:ie,autoSubmit:re,cid:_,doenetId:n,solutionDisplayMode:Y,baseNumberOfAttemptsAllowed:le}),i("Ready")},[d,N]),Re=D(({set:s})=>async()=>{s(de(x),l=>{let n={...l};return n.completed=!0,n.completedDate=new Date,n})},[x]);async function Pe(s,l){ae&&ae!=="#page1"&&ke(Ie,{replace:!0});let n=await Ne();n!==null&&clearTimeout(n);let p=null,o=await g.get("/api/getCidForAssignment.php",{params:{doenetId:l,latestAttemptOverrides:!1}});if(o.data.success)if(o.data.cid)p=o.data.cid;else{i("Problem"),e("Assignment is not assigned.");return}else{i("Problem"),e(`Error loading assignment: ${o.data.message}`);return}console.log(`retrieved cid: ${p}`);const{data:V}=await g.get("/api/loadTakenVariants.php",{params:{doenetId:l}});if(!V.success){i("Problem"),V.message?e(`Could not load assignment: ${V.message}`):e(`Could not load assignment: ${V}`);return}let R=V.variants.map(Number).slice(0,s-1);if(O.current===null){if(o=await g.get("/api/getIndividualizeForAssignment.php",{params:{doenetId:l}}),!o.data.success){i("Problem"),o.data.message?e(`Could not load assignment: ${o.data.message}`):e(`Could not load assignment: ${o.data}`);return}O.current=o.data.individualize==="1",i("Ready")}R.push(ee({previousVariants:R,allPossibleVariants:z.current,individualize:O.current,userId:L.current,doenetId:l,attemptNumber:s}));let P=R[R.length-1];E(H=>{let w={...H};return w.attemptNumber=s,w.requestedVariantIndex=P,w.cid=p,w}),k(!1)}const Be=D(({set:s})=>async({creditByItem:l,creditForAssignment:n,creditForAttempt:p,totalPointsOrPercent:o})=>{s(rt,{creditByItem:l,creditForAssignment:n,creditForAttempt:p,totalPointsOrPercent:o})});function Fe(s){console.log(`page changed to ${s}`)}async function Te(){let s=await g.post("/api/incrementAttemptsAllowedIfCidChanged.php",{doenetId:x});s.data.cidChanged&&(ye(Number(s.data.newNumberOfAttemptsAllowedAdjustment)),v(l=>l+1))}if(r==="")return null;if(console.log("stage",m),u==="__not_found__")return a("h1",{children:"Content not found or no permission to view content"});if(m==="Initializing")return null;if(A>F)return Pe(A,r),null;if(m==="Problem")return a("h1",{children:h});if(!(b!=null&&b.canViewAfterCompleted)&&b.completed)return Number(b.numberOfAttemptsAllowed)+Number(Ce)>F?a(X,{children:y("div",{style:{margin:"15px"},children:[a("h1",{children:"Assessment Complete"}),a("p",{children:"You have completed this assessment.  Would you like to begin another attempt?"}),a("p",{children:a(Z,{value:"Begin New Attempt",onClick:async()=>{const{data:l}=await g.get("/api/saveCompleted.php",{params:{doenetId:x}});l.success?(v(n=>n+1),Ve(n=>{let p={...n};return p.completed=!1,p})):(i("Problem"),e("Internal Error"))}})})]})}):a(X,{children:y("div",{style:{margin:"15px"},children:[a("h1",{children:"Assessment Complete"}),a("p",{children:"You have already completed this assessment and no additional attempts are available."})]})});let G=null;if(B)if(xe){let s=null;we>1&&(s=" and the number of available attempts"),G=a(ce,{type:"ACTION",value:y("div",{style:{border:"var(--mainBorder)",borderRadius:"var(--mainBorderRadius)",padding:"5px",margin:"5px",display:"flex",flexFlow:"column wrap"},children:["A new version of this activity is available. Do you want to start a new attempt using the new version? (This will reset the activity",s,".)",a("div",{style:{display:"flex",justifyContent:"center",padding:"5px"},children:y(nt,{children:[a(Z,{onClick:Te,dataTest:"ConfirmNewVersion",value:"Yes"}),a(Z,{onClick:()=>te(!1),dataTest:"CancelNewVersion",value:"No",alert:!0})]})})]})})}else G=a(ce,{type:"ACTION",value:a("div",{style:{marginLeft:"1px",marginRight:"5px"},children:a(st,{onClick:()=>te(!0),dataTest:"NewVersionAvailable",value:"New version available!"})})});const S=N.canViewUnassignedContent==="0";return y(X,{children:[G,a(Ze,{cid:Ae,doenetId:x,flags:{showCorrectness:c,readOnly:!1,solutionDisplayMode:ve,showFeedback:fe,showHints:he,autoSubmit:be,allowLoadState:S,allowSaveState:S,allowLocalState:S,allowSaveSubmissions:S,allowSaveEvents:S},attemptNumber:F,requestedVariantIndex:M,updateCreditAchievedCallback:Be,updateAttemptNumber:v,pageChangedCallback:Fe,paginate:T,showFinishButton:ge,cidChangedCallback:()=>k(!0),setActivityAsCompleted:Re},`activityViewer${x}`)]})}async function ot(r){let u;try{u=await Xe(r)}catch{return{success:!1,message:"Could not retrieve file"}}let d=tt(u);if(!d.success)return d;try{d=await at(d.activityJSON)}catch(m){return{success:!1,message:m.message}}return{success:!0,numberOfVariants:d.numberOfVariants}}export{lt as cidChangedAtom,rt as creditAchievedAtom,me as currentAttemptNumber,At as default,pe as numberOfAttemptsAllowedAdjustmentAtom};
