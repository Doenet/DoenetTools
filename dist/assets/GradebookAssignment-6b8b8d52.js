import{an as $,R as H,p as Z,e as I,s as Q,b as E,y as ee,r as _,G as te,j as t,a,F as J,v as se,o as ne,g as M,w as j,_ as ae,B as q}from"./index-66847aab.js";import{attemptData as re,overviewData as le,studentData as oe,assignmentData as K,Styles as ie,Table as de,attemptDataQuery as ce,studentDataQuery as ue,overviewDataQuery as me}from"./Gradebook-99969a7b.js";import{D as z}from"./DropdownMenu-fd0518ab.js";import{e as pe}from"./RoleDropdown-98d497ff.js";const L=$({key:"processGradesAtom",default:"Assignment Table"}),he=$({key:"headersGradesAtom",default:[]}),be=$({key:"entriesGradesAtom",default:[]}),fe=(i,n)=>{for(let r in i)if(i[r].firstName+" "+i[r].lastName==n)return r;return-1};function ge({doenetId:i,maxAttempts:n}){var x,O;let r=I(he),d=I(be);const c=se(),u=H(L);let D=E(K),[y,S]=_.useState(null),[f,T]=_.useState(1),[o,A]=_.useState(null),[m,w]=_.useState(1);const U=ne(({set:e,snapshot:l})=>async({doenetId:b,addToast:C})=>{const B=await l.getPromise(Q("courseId")),{data:{assignmentAttemptsData:W}}=await M.get("/api/loadGradebookAssignmentAttempts.php",{params:{courseId:B,doenetId:b}}),{data:{gradebookEnrollment:X}}=await M.get("/api/loadGradebookEnrollment.php",{params:{courseId:B}}),{data:{overview:Y}}=await M.get("/api/loadGradebookOverview.php",{params:{courseId:B}});e(ce(b),W),e(ue,X),e(me,Y),C("Updated scores!"),e(L,"Assignment Table")});if(D.state!=="hasValue")return null;const v=(O=(x=D.contents)==null?void 0:x[i])==null?void 0:O.totalPointsOrPercent;if(!r.includes("Email"))return c("Need a column header named 'Email' ",j.ERROR),u("Assignment Table"),null;let P=[],p=r.filter((e,l)=>{var C;let b=Number((C=d==null?void 0:d[0])==null?void 0:C[l]);return b==v&&P.push(l),b==v});if(p.length<1)return c(`Need a column with an assignment worth ${v} points in the second row`,j.ERROR),u("Assignment Table"),null;y||S(P[0]);let k=r.indexOf("Student"),V=r.indexOf("Email"),s=[],h=[],R=[];for(let e of d){let l=k===-1?null:e[k],b=e[V],C=e[y];b!==""&&(h.push(b),R.push(C),s.push(a("tr",{children:[" ",t("td",{children:l}),t("td",{children:b}),t("td",{children:C})]},b)))}let g=a("table",{children:[a("tr",{children:[t("th",{style:{width:"200px"},children:"Student"}),t("th",{style:{width:"200px"},children:"Email"}),t("th",{style:{width:"50px"},children:"Score"})]}),s]}),F=[];for(let[e,l]of Object.entries(p))F.push([e,l]);let N=[];o===null&&N.push([0,"Select Attempt Number"]);for(let e=1;e<=n;e++)N.push([e,`Attempt Number ${e}`]);N.push([Number(n)+1,"New Attempt Number"]);let G=null;return o&&(Number(n)+1===o?G=a("div",{children:["Use column ",t("b",{children:p[Number(f)-1]})," to insert a new ",a("b",{children:["Attempt Number ",o]}),"?"]}):G=a("div",{children:["Use column ",t("b",{children:p[Number(f)-1]})," to change ",a("b",{children:["Attempt Number ",o]})," scores?"]})),o&&(p[Number(f)-1],Number(n)+1),a(J,{children:[a("div",{children:[p.length," column",p.length>1?"s":null," match"," ",v," total points"," "]}),t("div",{children:t(z,{items:F,valueIndex:f,width:"400px",onChange:({value:e})=>{T(Number(e)+1),S(P[e])}})}),t("br",{}),t("div",{children:t(z,{items:N,valueIndex:m,width:"400px",onChange:({value:e})=>{w(e),A(e)}})}),t("br",{}),G,a(ae,{children:[t(q,{alert:!0,value:"Cancel",onClick:()=>{c("Override Cancelled"),u("Assignment Table")}}),o?t(q,{value:"Accept",onClick:()=>{let e={doenetId:i,attemptNumber:o,emails:h,scores:R};M.post("/api/saveOverrideGrades.php",e).catch(l=>{c(l,j.ERROR),u("Assignment Table")}).then(({data:l})=>{l.success?U({doenetId:i,addToast:c}):c(l.message,j.ERROR)})}}):null]}),t("br",{}),g]})}function xe(){var U,v,P,p,k,V;const i=H(Z);let n=I(Q("doenetId")),r=I(Q("courseId")),d=E(re(n)),c=E(le),u=E(oe),D=I(L);const y=H(ee);let{canViewAndModifyGrades:S}=I(pe(r)),f=E(K);_.useEffect(()=>{y(S==="1"?[]:["GradeUpload"])},[S,y]);let T=I(te(r));if((T==null?void 0:T.canViewCourse)=="0")return t("h1",{children:"No Access to view this page."});if(d.state!=="hasValue"||u.state!=="hasValue"||f.state!=="hasValue")return null;const o=f.contents[n].label,A=Number((U=f.contents[n])==null?void 0:U.totalPointsOrPercent);let m={},w=0;for(let s in d.contents)if((v=d.contents[s])!=null&&v.attempts){let h=Math.max(...Object.keys(d.contents[s].attempts).map(Number));h>w&&(w=h)}if(D==="Upload Choice Table")return t(ge,{doenetId:n,maxAttempts:w});m.headers=[],m.headers.push({Header:"Student",Footer:"Possible Points",accessor:"student"});for(let s=1;s<=w;s++)m.headers.push({Header:"Attempt "+s,Footer:A,accessor:"a"+s,disableFilters:!0,Cell:h=>t("a",{onClick:()=>{let R=h.cell.row.cells[0].value.props.children,g=fe(u.contents,R);i({page:"course",tool:"gradebookStudentAssignment",view:"",params:{courseId:r,doenetId:n,userId:g,attemptNumber:s,previousCrumb:"assignment"}})},children:h.value})});m.headers.push({Header:"Assignment Total",Footer:A,accessor:"grade",disableFilters:!0}),m.rows=[];for(let s in u.contents){let h=u.contents[s].firstName,R=u.contents[s].lastName,g={},F=h+" "+R;g.student=t("a",{onClick:()=>{i({page:"course",tool:"gradebookStudentAssignment",view:"",params:{courseId:r,doenetId:n,userId:s,previousCrumb:"assignment"}})},children:F});for(let x=1;x<=w;x++){let O=(P=d.contents[s])==null?void 0:P.attempts[x],e=Math.round(O*A*100)/100;g["a"+x]=O===void 0?"":e}let N=(V=(k=(p=c==null?void 0:c.contents)==null?void 0:p[s])==null?void 0:k.assignments)==null?void 0:V[n],G=Math.round(N*A*100)/100;g.grade=N?G:"0",m.rows.push(g)}return a(J,{children:[t("div",{style:{paddingLeft:"8px"},children:t("b",{children:o})}),a("div",{style:{paddingLeft:"8px"},children:[A," Points Possible"]}),t(ie,{children:t(de,{columns:m.headers,data:m.rows})})]})}export{xe as default,be as entriesGradesAtom,he as headersGradesAtom,L as processGradesAtom};
