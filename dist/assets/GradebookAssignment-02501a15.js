import{ag as $,R as H,p as Z,l as C,m as Q,b as O,E as ee,r as D,I as te,j as t,a,F as J,y as se,v as ne,k as M,z as B,B as z}from"./index-87746167.js";import{attemptData as ae,overviewData as re,studentData as le,assignmentData as K,Styles as oe,Table as ie,attemptDataQuery as de,studentDataQuery as ce,overviewDataQuery as me}from"./Gradebook-1573ea11.js";import{B as ue}from"./ButtonGroup-2381356e.js";import{D as q}from"./DropdownMenu-7a97c92a.js";import{e as pe}from"./RoleDropdown-da34b767.js";import"./setPrototypeOf-51e8cf87.js";const L=$({key:"processGradesAtom",default:"Assignment Table"}),he=$({key:"headersGradesAtom",default:[]}),be=$({key:"entriesGradesAtom",default:[]}),fe=(i,n)=>{for(let r in i)if(i[r].firstName+" "+i[r].lastName==n)return r;return-1};function ge({doenetId:i,maxAttempts:n}){var x,G;let r=C(he),d=C(be);const c=se(),m=H(L);let _=O(K),[y,k]=D.useState(null),[f,S]=D.useState(1),[o,A]=D.useState(null),[u,w]=D.useState(1);const U=ne(({set:e,snapshot:l})=>async({doenetId:b,addToast:I})=>{const j=await l.getPromise(Q("courseId")),{data:{assignmentAttemptsData:W}}=await M.get("/api/loadGradebookAssignmentAttempts.php",{params:{courseId:j,doenetId:b}}),{data:{gradebookEnrollment:X}}=await M.get("/api/loadGradebookEnrollment.php",{params:{courseId:j}}),{data:{overview:Y}}=await M.get("/api/loadGradebookOverview.php",{params:{courseId:j}});e(de(b),W),e(ce,X),e(me,Y),I("Updated scores!"),e(L,"Assignment Table")});if(_.state!=="hasValue")return null;const v=(G=(x=_.contents)==null?void 0:x[i])==null?void 0:G.totalPointsOrPercent;if(!r.includes("Email"))return c("Need a column header named 'Email' ",B.ERROR),m("Assignment Table"),null;let P=[],p=r.filter((e,l)=>{var I;let b=Number((I=d==null?void 0:d[0])==null?void 0:I[l]);return b==v&&P.push(l),b==v});if(p.length<1)return c(`Need a column with an assignment worth ${v} points in the second row`,B.ERROR),m("Assignment Table"),null;y||k(P[0]);let T=r.indexOf("Student"),V=r.indexOf("Email"),s=[],h=[],R=[];for(let e of d){let l=T===-1?null:e[T],b=e[V],I=e[y];b!==""&&(h.push(b),R.push(I),s.push(a("tr",{children:[" ",t("td",{children:l}),t("td",{children:b}),t("td",{children:I})]},b)))}let g=a("table",{children:[a("tr",{children:[t("th",{style:{width:"200px"},children:"Student"}),t("th",{style:{width:"200px"},children:"Email"}),t("th",{style:{width:"50px"},children:"Score"})]}),s]}),F=[];for(let[e,l]of Object.entries(p))F.push([e,l]);let N=[];o===null&&N.push([0,"Select Attempt Number"]);for(let e=1;e<=n;e++)N.push([e,`Attempt Number ${e}`]);N.push([Number(n)+1,"New Attempt Number"]);let E=null;return o&&(Number(n)+1===o?E=a("div",{children:["Use column ",t("b",{children:p[Number(f)-1]})," to insert a new ",a("b",{children:["Attempt Number ",o]}),"?"]}):E=a("div",{children:["Use column ",t("b",{children:p[Number(f)-1]})," to change ",a("b",{children:["Attempt Number ",o]})," scores?"]})),o&&(p[Number(f)-1],Number(n)+1),a(J,{children:[a("div",{children:[p.length," column",p.length>1?"s":null," match"," ",v," total points"," "]}),t("div",{children:t(q,{items:F,valueIndex:f,width:"400px",onChange:({value:e})=>{S(Number(e)+1),k(P[e])}})}),t("br",{}),t("div",{children:t(q,{items:N,valueIndex:u,width:"400px",onChange:({value:e})=>{w(e),A(e)}})}),t("br",{}),E,a(ue,{children:[t(z,{alert:!0,value:"Cancel",onClick:()=>{c("Override Cancelled"),m("Assignment Table")}}),o?t(z,{value:"Accept",onClick:()=>{let e={doenetId:i,attemptNumber:o,emails:h,scores:R};M.post("/api/saveOverrideGrades.php",e).catch(l=>{c(l,B.ERROR),m("Assignment Table")}).then(({data:l})=>{l.success?U({doenetId:i,addToast:c}):c(l.message,B.ERROR)})}}):null]}),t("br",{}),g]})}function Ce(){var U,v,P,p,T,V;const i=H(Z);let n=C(Q("doenetId")),r=C(Q("courseId")),d=O(ae(n)),c=O(re),m=O(le),_=C(L);const y=H(ee);let{canViewAndModifyGrades:k}=C(pe(r)),f=O(K);D.useEffect(()=>{y(k==="1"?[]:["GradeUpload"])},[k,y]);let S=C(te(r));if((S==null?void 0:S.canViewCourse)=="0")return t("h1",{children:"No Access to view this page."});if(d.state!=="hasValue"||m.state!=="hasValue"||f.state!=="hasValue")return null;const o=f.contents[n].label,A=Number((U=f.contents[n])==null?void 0:U.totalPointsOrPercent);let u={},w=0;for(let s in d.contents)if((v=d.contents[s])!=null&&v.attempts){let h=Math.max(...Object.keys(d.contents[s].attempts).map(Number));h>w&&(w=h)}if(_==="Upload Choice Table")return t(ge,{doenetId:n,maxAttempts:w});u.headers=[],u.headers.push({Header:"Student",Footer:"Possible Points",accessor:"student"});for(let s=1;s<=w;s++)u.headers.push({Header:"Attempt "+s,Footer:A,accessor:"a"+s,disableFilters:!0,Cell:h=>t("a",{onClick:()=>{let R=h.cell.row.cells[0].value.props.children,g=fe(m.contents,R);i({page:"course",tool:"gradebookStudentAssignment",view:"",params:{courseId:r,doenetId:n,userId:g,attemptNumber:s,previousCrumb:"assignment"}})},children:h.value})});u.headers.push({Header:"Assignment Total",Footer:A,accessor:"grade",disableFilters:!0}),u.rows=[];for(let s in m.contents){let h=m.contents[s].firstName,R=m.contents[s].lastName,g={},F=h+" "+R;g.student=t("a",{onClick:()=>{i({page:"course",tool:"gradebookStudentAssignment",view:"",params:{courseId:r,doenetId:n,userId:s,previousCrumb:"assignment"}})},children:F});for(let x=1;x<=w;x++){let G=(P=d.contents[s])==null?void 0:P.attempts[x],e=Math.round(G*A*100)/100;g["a"+x]=G===void 0?"":e}let N=(V=(T=(p=c==null?void 0:c.contents)==null?void 0:p[s])==null?void 0:T.assignments)==null?void 0:V[n],E=Math.round(N*A*100)/100;g.grade=N?E:"0",u.rows.push(g)}return a(J,{children:[t("div",{style:{paddingLeft:"8px"},children:t("b",{children:o})}),a("div",{style:{paddingLeft:"8px"},children:[A," Points Possible"]}),t(oe,{children:t(ie,{columns:u.headers,data:u.rows})})]})}export{Ce as default,be as entriesGradesAtom,he as headersGradesAtom,L as processGradesAtom};
