import{l as x,m as J,b as re,y as de,v as B,k as b,z as g,af as k,ai as T,aB as ce,j as c,a as E,F as le,B as O,ah as X}from"./index-404de25b.js";import{i as w,f as K,b as P,C as me,R as fe}from"./CourseToolHandler-94ff05aa.js";import{R as Q}from"./RelatedItems-d2b78c94.js";import{e as De,t as _}from"./EditorViewerRecoil-b095dcf9.js";import"./index-db648f91.js";import"./index-fcf36459.js";import"./index-47ca4f11.js";import"./index.esm-8d3601fa.js";import"./setPrototypeOf-51e8cf87.js";/* empty css             */import"./ButtonGroup-c43b7e60.js";const A=X({key:"currentDraftSelectedAtom",default:!0}),j=X({key:"selectedVersionIdAtom",default:null});function Se(Y){var q;console.log(">>>===VersionHistory");const R=x(J("doenetId")),Z=decodeURIComponent(x(J("path"))),S=re(w(R)),ee=x(De),te=x(j),h=de(),V=x(A),[F,L,U]=Z.split(":"),ne=B(({set:t,snapshot:l})=>async({doenetId:e,versionId:I,driveId:m,folderId:r,itemId:d})=>{const{data:o}=await b.get("/api/releaseVersion.php",{params:{doenetId:e,versionId:I}}),{success:f,message:u,isReleased:D,title:p}=o;let y="Retracted";D==="1"&&(y="Released"),f?h(`"${p}" is ${y}`,g.SUCCESS):h(u,g.ERROR),t(w(e),a=>{let n={...a},s=[...a.named];for(const[v,N]of s.entries()){let C={...N};N.versionId===I?(C.isReleased=D,s[v]=C):(C.isReleased="0",s[v]=C)}return n.named=s,n}),t(K({driveId:m,folderId:r}),a=>{let n={...a};for(let s of n.contentIds.defaultOrder)if(n.contentsDictionary[s].doenetId===e){d=s;break}return n.contentsDictionary={...a.contentsDictionary},n.contentsDictionary[d]={...a.contentsDictionary[d]},n.contentsDictionary[d].isReleased=D,n.contentsDictionaryByDoenetId={...a.contentsDictionaryByDoenetId},n.contentsDictionaryByDoenetId[e]={...a.contentsDictionaryByDoenetId[e]},n.contentsDictionaryByDoenetId[e].isReleased=D,n})}),ie=B(({snapshot:t,set:l})=>async({doenetId:e,versionId:I})=>{const m=await t.getPromise(w(e));let r={...m.draft};r.isDraft="0";const d=`Save (current) ${m.named.length+1}`;r.title=d,r.timestamp=P();let o={};for(let p of m.named)p.versionId===I&&(o={...p});const f=k();o.versionId=f,o.isDraft="1",o.isNamed="0",o.isReleased="0";let u={...m};u.named=[r,...m.named],u.draft=o,l(w(e),u),l(A,!0),l(j,f);let D={...o,isSetAsCurrent:"1",newDraftVersionId:f,newDraftContentId:o.cid,doenetId:e,newTitle:d};b.post("/api/saveNewVersion.php",D)}),se=B(({snapshot:t,set:l})=>async e=>{const I=await t.getPromise(_),m=P(),r=await T(I),d=k(),o=await t.getPromise(w(e));let f={...o},D={title:`Save ${o.named.length+1}`,versionId:d,timestamp:m,isReleased:"0",isDraft:"0",isNamed:"1",cid:r},p={...D,doenetML:I,doenetId:e};f.named=[D,...o.named],l(w(e),f),b.post("/api/saveNewVersion.php",p).then(y=>{var a,n;(a=y==null?void 0:y.data)!=null&&a.success?h("New Version Saved!",g.SUCCESS):(h("Version NOT Saved!",g.ERROR),console.error((n=y.data)==null?void 0:n.message))}).catch(y=>{h("Version NOT Saved!",g.ERROR)})}),oe=B(({snapshot:t,set:l})=>async({doenetId:e,driveId:I,folderId:m,itemId:r})=>{const d=await t.getPromise(_),o=ce(new Date),f=await T(d),u=k(),{data:D}=await b.post("/api/releaseDraft.php",{doenetId:e,doenetML:d,timestamp:o,versionId:u}),{success:p,message:y,title:a}=D;p?h(`"${a}" is Released.`,g.SUCCESS):h(y,g.ERROR),l(w(e),n=>{let s={...n},v=[...n.named];for(const[C,ae]of v.entries()){let G={...ae};G.isReleased="0",v[C]=G}let N={title:a,versionId:u,timestamp:o,isReleased:"1",isDraft:"0",isNamed:"1",cid:f};return v.unshift(N),s.named=v,s}),l(K({driveId:I,folderId:m}),n=>{let s={...n};for(let v of s.contentIds.defaultOrder)if(s.contentsDictionary[v].doenetId===e){r=v;break}return s.contentsDictionary={...n.contentsDictionary},s.contentsDictionary[r]={...n.contentsDictionary[r]},s.contentsDictionary[r].isReleased="1",s.contentsDictionaryByDoenetId={...n.contentsDictionaryByDoenetId},s.contentsDictionaryByDoenetId[e]={...n.contentsDictionaryByDoenetId[e]},s.contentsDictionaryByDoenetId[e].isReleased="1",s})}),$=B(({snapshot:t,set:l})=>async({doenetId:e,versionId:I,isCurrentDraft:m})=>{l(j,I),l(A,m);const r=await t.getPromise(w(e));let d={...r},o=r.draft.cid;if(!m&&await t.getPromise(A)){const u=await t.getPromise(_),D=await T(u);if(D!==o){let p={...r.draft};p.cid=D,p.timestamp=P(),d.draft=p,l(w(e),d);let y={...p,doenetML:u,doenetId:e};try{const{data:a}=await b.post("/api/saveNewVersion.php",y);a.success||console.log("ERROR",a.message)}catch(a){console.log("ERROR",a)}}}d.draft.cid;for(let f of d.named)if(f.versionId===I){f.cid;break}});if(ee!==R)return c("div",{style:Y.style});if(!((q=S==null?void 0:S.contents)!=null&&q.named))return null;let M=[],z={},H=te;for(let t of S.contents.named){z[t.versionId]=t;let l=!1;t.versionId===H&&(l=!0);let e="";t.isReleased==="1"&&(e="(Released)"),M.push(E("option",{value:t.versionId,selected:l,children:[e," ",t.title]},`option${t.versionId}`))}const i=z[H];let W="Release";return(i==null?void 0:i.isReleased)==="1"&&(W="Retract"),E(le,{children:[c("div",{style:{padding:"6px 0px 6px 0px"},children:c(Q,{size:"2",width:"menu",onChange:t=>{$({doenetId:R,versionId:t.target.value,isCurrentDraft:!0})},options:c("option",{value:S.contents.draft.versionId,selected:V,children:"Current Draft"})})}),c("div",{style:{margin:"0px 0px 6px 0px"},children:c(O,{disabled:!V,width:"menu",value:"Save Version",onClick:()=>se(R)})}),c("div",{style:{margin:"6px 0px 6px 0px"},children:c(O,{disabled:!V,width:"menu",value:"Release Current",onClick:()=>{oe({doenetId:R,driveId:F,folderId:L,itemId:U})}})}),c("div",{children:"History"}),c(Q,{size:"8",width:"menu",onChange:t=>{$({doenetId:R,versionId:t.target.value,isCurrentDraft:!1})},options:M}),E("div",{children:["Name: ",i==null?void 0:i.title]}),c(me,{disabled:V,cid:i==null?void 0:i.cid,doenetId:R}),c("div",{children:c(fe,{disabled:V,doenetId:R,title:i==null?void 0:i.title,versionId:i==null?void 0:i.versionId},i==null?void 0:i.versionId)}),c("div",{children:c(O,{disabled:V,onClick:()=>ie({doenetId:R,versionId:i.versionId}),value:"Set As Current"})}),c("div",{children:c(O,{disabled:V,onClick:()=>ne({doenetId:R,versionId:i.versionId,driveId:F,folderId:L,itemId:U}),value:W})})]})}export{A as currentDraftSelectedAtom,Se as default,j as selectedVersionIdAtom};
