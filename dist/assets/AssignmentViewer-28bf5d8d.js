import{r as g,a as y,j as s,H as qe,aN as Ue,e as T,s as He,q as Ge,R as Ye,y as Qe,l as $,p as ue,O as We,P as Je,A as ce,u as Ke,f as Xe,b as Ze,c as et,o as j,g as p,F as J,B as K,D as tt,an as R,aO as at,_ as st,aP as nt,ak as it,al as rt,aQ as lt}from"./index-66847aab.js";import{e as ot}from"./RoleDropdown-98d497ff.js";import"./DropdownMenu-fd0518ab.js";function me(l){const[u,d]=g.useState("flex");var m={padding:"10px",display:`${u}`,alignItems:"center"},i={flexGrow:"1",lineHeight:"1.4",fontFamily:"Open Sans",fontSize:"16px"},f={background:"none",border:"0px",marginLeft:"5px",padding:"0px",value:"Label:",fontFamily:"Open Sans",fontSize:"14px",cursor:"pointer"},e={};switch(l.type){case"ERROR":e.backgroundColor="var(--mainRed)",e.color="var(--canvas)",f.color="var(--canvas)";break;case"ALERT":e.backgroundColor="var(--lightYellow)";break;case"ACTION":e.backgroundColor="var(--lightBlue)";break;case"SUCCESS":e.backgroundColor="var(--lightGreen)";break;default:e.backgroundColor="var(--mainGreen)";break}function b(){d("none")}return l.allowClose&&(e.closeButton=s("button",{"aria-label":"Close banner",style:f,onClick:()=>{b()},children:s(qe,{icon:Ue})})),y("div",{"aria-labelledby":"banner-text",children:[s("div",{style:e,children:y("div",{style:m,children:[s("div",{style:i,id:"banner-text",children:l.value}),e.closeButton]})}),s("div",{style:{padding:"5px"}})]})}const pe=R({key:"currentAttemptNumber",default:null}),dt=R({key:"creditAchievedAtom",default:{creditByItem:[],creditForAttempt:0,creditForAssignment:0,totalPointsOrPercent:0}}),ut=R({key:"activityStatusAtom",default:{currentPage:0,activityAttemptNumberSetUp:0,itemWeights:[]}}),ge=R({key:"numberOfAttemptsAllowedAdjustment",default:0}),ct=R({key:"cidChanged",default:!1});function X({previousVariants:l,allPossibleVariants:u,individualize:d,userId:m,doenetId:i,attemptNumber:f}){let e=[],b=(f-1)%u.length,v=[];if(b>0)for(let c=f-b;c<f;c++)if(l[c-1])v.push(l[c-1]);else{let _=X({previousVariants:l.slice(0,c-1),allPossibleVariants:u,individualize:d,userId:m,doenetId:i,attemptNumber:c});l[c-1]=_,v.push(_)}for(let c of u)v.includes(c)||e.push(c);let F=i+"|"+f;d&&(F+="|"+m);let I=new at(F);const E=Math.floor(I()*e.length);return e[E]}function ht(){const l=T(He("doenetId")),u=T(Ge),d=Ye(Qe);let[m,i]=g.useState("Initializing"),[f,e]=g.useState("");const[b,v]=$(pe),[F,I]=$(ct),[{requestedVariantIndex:E,attemptNumber:B,showCorrectness:c,paginate:_,showFinishButton:fe,showFeedback:he,showHints:Ae,autoSubmit:be,cid:ve,doenetId:C,solutionDisplayMode:we,baseNumberOfAttemptsAllowed:ye},L]=g.useState({}),[Ce,xe]=$(ge),[Ne,Z]=g.useState(!1),Se=T(ue);let M=g.useRef([]),z=g.useRef(null),V=g.useRef(null);We(l),Je(u);const x=T(ot(u));let[h,Ie]=$(ce(l)),q=h.label,ee=Ke(),{search:Ve,hash:te}=ee,ae=Xe();g.useEffect(()=>{const n=document.title;return q&&(document.title=`${q} - Doenet`),()=>{document.title=n}},[q]),g.useEffect(()=>{Object.keys(h).length>0&&Object.keys(x).length>0&&Oe(l,h)},[h,l,x]);const ke=Ze(et);z.current=ke.contents.userId;const Oe=j(({snapshot:n,set:o})=>async(a,{type:r,timeLimit:A,assignedDate:O,dueDate:se,showCorrectness:P,showCreditAchievedMenu:N,paginate:ne,showFinishButton:ie,showFeedback:re,showHints:le,autoSubmit:oe,showSolution:je,proctorMakesAvailable:Ee,numberOfAttemptsAllowed:de})=>{if(r===void 0)return;let H=[];A===null&&H.push("TimerMenu"),(!P||!N||x.canViewUnassignedContent!=="0")&&H.push("CreditAchieved"),d(H);let G="button";if(!je&&x.canViewUnassignedContent==="0"&&(G="none"),Ee){const{page:W}=await n.getPromise(ue);if(W!=="exam"){i("Problem"),e("Assignment only available in a proctored setting.");return}else{const{data:ze}=await p.get("/api/checkSEBheaders.php",{params:{doenetId:a}});if(Number(ze.legitAccessKey)!==1){i("Problem"),e("Browser not configured properly to take an exam.");return}}}let D=null,t=await p.get("/api/getCidForAssignment.php",{params:{doenetId:a,latestAttemptOverrides:!0}});if(t.data.success)if(t.data.cid)D=t.data.cid;else{i("Problem"),e("Assignment is not assigned.");return}else{i("Problem"),e(`Error loading assignment: ${t.data.message}`);return}if(I(t.data.cidChanged),t=await p.get("/api/loadTakenVariants.php",{params:{doenetId:a}}),!t.data.success){i("Problem"),t.data.message?e(`Could not load assignment: ${t.data.message}`):e(`Could not load assignment: ${t.data}`);return}let S=t.data.variants.map(Number),w=Math.max(...t.data.attemptNumbers.map(Number)),Y=!1;if(w<1?(w=1,Y=!0):t.data.variants[t.data.variants.length-1]===null&&(Y=!0),o(pe,w),t=await p.get("/api/loadAttemptsAllowedAdjustment.php",{params:{doenetId:a}}),!t.data.success){i("Problem"),t.data.message?e(`Could not load assignment: ${t.data.message}`):e(`Could not load assignment: ${t.data}`);return}let Le=Number(t.data.numberOfAttemptsAllowedAdjustment);o(ge,Le);let Q=await mt(D);if(!Q.success){L({requestedVariantIndex:0,attemptNumber:w,showCorrectness:P,paginate:ne,showFinishButton:ie,showFeedback:re,showHints:le,autoSubmit:oe,cid:D,doenetId:a,solutionDisplayMode:G,baseNumberOfAttemptsAllowed:de}),i("Problem"),e(Q.message);return}if(M.current=[...Array(Q.numVariants).keys()].map(W=>W+1),Y){if(t=await p.get("/api/getIndividualizeForAssignment.php",{params:{doenetId:a}}),!t.data.success){i("Problem"),t.data.message?e(`Could not load assignment: ${t.data.message}`):e(`Could not load assignment: ${t.data}`);return}V.current=t.data.individualize==="1",S=S.slice(0,w-1),S.push(X({previousVariants:S,allPossibleVariants:M.current,individualize:V.current,userId:z.current,doenetId:a,attemptNumber:w}))}let Me=S[S.length-1];L({requestedVariantIndex:Me,attemptNumber:w,showCorrectness:P,paginate:ne,showFinishButton:ie,showFeedback:re,showHints:le,autoSubmit:oe,cid:D,doenetId:a,solutionDisplayMode:G,baseNumberOfAttemptsAllowed:de}),i("Ready")},[d,x]),Pe=j(({set:n})=>async()=>{n(ce(C),o=>{let a={...o};return a.completed=!0,a.completedDate=new Date,a})},[C]);async function Re(n,o){te&&te!=="#page1"&&ae(Ve,{replace:!0});let a=null,r=await p.get("/api/getCidForAssignment.php",{params:{doenetId:o,latestAttemptOverrides:!1}});if(r.data.success)if(r.data.cid)a=r.data.cid;else{i("Problem"),e("Assignment is not assigned.");return}else{i("Problem"),e(`Error loading assignment: ${r.data.message}`);return}console.log(`retrieved cid: ${a}`);const{data:A}=await p.get("/api/loadTakenVariants.php",{params:{doenetId:o}});if(!A.success){i("Problem"),A.message?e(`Could not load assignment: ${A.message}`):e(`Could not load assignment: ${A}`);return}let O=A.variants.map(Number).slice(0,n-1);if(V.current===null){if(r=await p.get("/api/getIndividualizeForAssignment.php",{params:{doenetId:o}}),!r.data.success){i("Problem"),r.data.message?e(`Could not load assignment: ${r.data.message}`):e(`Could not load assignment: ${r.data}`);return}V.current=r.data.individualize==="1",i("Ready")}O.push(X({previousVariants:O,allPossibleVariants:M.current,individualize:V.current,userId:z.current,doenetId:o,attemptNumber:n}));let se=O[O.length-1];L(P=>{let N={...P};return N.attemptNumber=n,N.requestedVariantIndex=se,N.cid=a,N}),I(!1)}const Fe=j(({set:n})=>async({creditByItem:o,creditForAssignment:a,creditForAttempt:r,totalPointsOrPercent:A})=>{n(dt,{creditByItem:o,creditForAssignment:a,creditForAttempt:r,totalPointsOrPercent:A})}),Be=j(({set:n})=>async({itemWeights:o,currentPage:a,activityAttemptNumberSetUp:r})=>{n(ut,{itemWeights:o,currentPage:a,activityAttemptNumberSetUp:r})});function _e(n){}async function De(){let n=await p.post("/api/incrementAttemptsAllowedIfCidChanged.php",{doenetId:C});n.data.cidChanged&&(xe(Number(n.data.newNumberOfAttemptsAllowedAdjustment)),v(o=>o+1))}if(l==="")return null;if(u==="__not_found__")return s("h1",{children:"Content not found or no permission to view content"});if(m==="Initializing")return null;if(b>B)return Re(b,l),null;if(m==="Problem")return s("h1",{children:f});if(!(h!=null&&h.canViewAfterCompleted)&&h.completed)return Number(h.numberOfAttemptsAllowed)+Number(Ce)>B?s(J,{children:y("div",{style:{margin:"15px"},children:[s("h1",{children:"Assessment Complete"}),s("p",{children:"You have completed this assessment. Would you like to begin another attempt?"}),s("p",{children:s(K,{value:"Begin New Attempt",onClick:async()=>{const{data:o}=await p.get("/api/saveCompleted.php",{params:{doenetId:C}});o.success?(v(a=>a+1),Ie(a=>{let r={...a};return r.completed=!1,r})):(i("Problem"),e("Internal Error"))}})})]})}):s(J,{children:y("div",{style:{margin:"15px"},children:[s("h1",{children:"Assessment Complete"}),s("p",{children:"You have already completed this assessment and no additional attempts are available."})]})});let U=null;if(F)if(Ne){let n=null;ye>1&&(n=" and the number of available attempts"),U=s(me,{type:"ACTION",value:y("div",{style:{border:"var(--mainBorder)",borderRadius:"var(--mainBorderRadius)",padding:"5px",margin:"5px",display:"flex",flexFlow:"column wrap"},children:["A new version of this activity is available. Do you want to start a new attempt using the new version? (This will reset the activity",n,".)",s("div",{style:{display:"flex",justifyContent:"center",padding:"5px"},children:y(st,{children:[s(K,{onClick:De,dataTest:"ConfirmNewVersion",value:"Yes"}),s(K,{onClick:()=>Z(!1),dataTest:"CancelNewVersion",value:"No",alert:!0})]})})]})})}else U=s(me,{type:"ACTION",value:s("div",{style:{marginLeft:"1px",marginRight:"5px"},children:s(nt,{onClick:()=>Z(!0),dataTest:"NewVersionAvailable",value:"New version available!"})})});const k=x.canViewUnassignedContent==="0",Te={loadActivityState:"/api/loadActivityState.php",saveActivityState:"/api/saveActivityState.php",initAssignmentAttempt:"/api/initAssignmentAttempt.php",recordEvent:"/api/recordEvent.php",saveCompleted:"/api/saveCompleted.php",loadPageState:"/api/loadPageState.php",savePageState:"/api/savePageState.php",saveCreditForItem:"/api/saveCreditForItem.php",reportSolutionViewed:"/api/reportSolutionViewed.php"},$e=document.getElementById("mainPanel");return y(J,{children:[U,s(tt,{cid:ve,activityId:C,flags:{showCorrectness:c,readOnly:!1,solutionDisplayMode:we,showFeedback:he,showHints:Ae,autoSubmit:be,allowLoadState:k,allowSaveState:k,allowLocalState:k,allowSaveSubmissions:k,allowSaveEvents:k},attemptNumber:B,requestedVariantIndex:E,updateCreditAchievedCallback:Fe,updateActivityStatusCallback:Be,updateAttemptNumber:v,pageChangedCallback:_e,paginate:_,location:ee,navigate:ae,showFinishButton:fe,cidChangedCallback:()=>I(!0),setActivityAsCompleted:Pe,idsIncludeActivityId:!1,linkSettings:{viewURL:Se.page==="placementexam"?"/course?tool=exam":"/course?tool=assignment",editURL:"/public?tool=editor",useQueryParameters:!0},apiURLs:Te,scrollableContainer:$e},`activityViewer${C}`)]})}async function mt(l){let u;try{u=await it(l)}catch{return{success:!1,message:"Could not retrieve file"}}let d=await rt(u,l);if(d.errors.length>0)return{success:!1,message:d.errors[0].message};try{d=await lt(d.activityJSON)}catch(m){return{success:!1,message:m.message}}return{success:!0,numVariants:d.numVariants}}export{ut as activityStatusAtom,ct as cidChangedAtom,dt as creditAchievedAtom,pe as currentAttemptNumber,ht as default,ge as numberOfAttemptsAllowedAdjustmentAtom};
