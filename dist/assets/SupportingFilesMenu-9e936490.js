import{y as se,l as re,m as ne,g as pe,r as x,v as N,k as b,z as f,b1 as de,a as u,F as ue,j as t,B as ce,ay as ge,az as K,i as Q}from"./index-87746167.js";import{A as q}from"./ActionButtonGroup-2b1b3423.js";import{A as C}from"./ActionButton-dc5d17c4.js";import{B as he}from"./ButtonGroup-2381356e.js";import{C as me}from"./CollapseSection-506ef5c7.js";import{l as G}from"./index-a5d2d475.js";import{f as H}from"./index-47ca4f11.js";import"./index-fcf36459.js";function L(n){var a=["Bytes","KB","MB","GB","TB"];if(n==0)return"0 Byte";var l=parseInt(Math.floor(Math.log(n)/Math.log(1024)));return Math.round(n/Math.pow(1024,l),2)+" "+a[l]}const J=ge({key:"supportingFilesAndPermissionByDoenetId",default:K({key:"supportingFilesAndPermissionByDoenetId/Default",get:n=>async()=>{let{data:a}=await b.get("/api/loadSupprtingFileInfo.php",{params:{doenetId:n}});return a}})}),A=K({get:n=>({get:a})=>a(J(n)),set:n=>({set:a},l)=>{a(J(n),l)}});function T({text:n,submit:a}){a||(a=()=>{});let[l,F]=x.useState(!1),[y,S]=x.useState(n),v=n;l||(v=y);let $={width:"110px",display:"inline-block",textOverflow:"ellipsis",whiteSpace:"nowrap"};return v===""&&(v=" *Required",$.border="solid 2px var(--mainRed)"),l?t("input",{autoFocus:!0,type:"text",style:{width:"116px"},value:y,onChange:w=>S(w.target.value),onBlur:w=>{F(!1),a(y)},onKeyDown:w=>{w.key==="Enter"&&(F(!1),a(y))}}):t("span",{style:$,onClick:()=>F(!0),children:v})}function Be(n){const a=se(),l=re(ne("doenetId")),[{canUpload:F,userQuotaBytesAvailable:y,supportingFiles:S,quotaBytes:v,canEditContent:$},w]=pe(A(l));let X=["text/csv","image/jpeg","image/png"],[V,D]=x.useState([]),R=x.useRef(0);const W=N(({set:i})=>async(r,s)=>{await b.get("/api/updateFileDescription.php",{params:{doenetId:l,cid:s,description:r}}),i(A(l),c=>{let g={...c},e=[...c.supportingFiles];return e.map((p,o)=>{p.cid===s&&(e[o]={...e[o]},e[o].description=r)}),g.supportingFiles=e,g})},[l]),_=N(({set:i})=>async(r,s)=>{await b.get("/api/updateFileAsFileName.php",{params:{doenetId:l,cid:s,asFileName:r}}),i(A(l),c=>{let g={...c},e=[...c.supportingFiles];return e.map((p,o)=>{p.cid===s&&(e[o]={...e[o]},e[o].asFileName=r)}),g.supportingFiles=e,g})},[l]),z=N(({set:i})=>async r=>{var s,c,g;try{let e=await b.get("/api/deleteFile.php",{params:{doenetId:l,cid:r}});if(e.status<300&&((s=e==null?void 0:e.data)!=null&&s.success)){a("File deleted.");let{userQuotaBytesAvailable:p}=e.data;i(A(l),o=>{let h={...o};return h.supportingFiles=o.supportingFiles.filter(d=>d.cid!==r),h.userQuotaBytesAvailable=p,h})}else if(((c=e==null?void 0:e.data)==null?void 0:c.success)==!1)a((g=e==null?void 0:e.data)==null?void 0:g.message,f.ERROR);else throw new Error(`response code: ${e.status}`)}catch(e){throw new Error(`Error deleting file ${e}`)}},[l]),Y=x.useCallback(i=>{let r=!0,s=0;i.map(e=>{X.includes(e.type)||(a(`File '${e.name}' of type '${e.type}' is not allowed. No files uploaded.`,f.ERROR),r=!1),s+=e.size});let c=L(s),g=L(s-y);s>y&&(a(`Upload size ${c} exceeds quota by ${g}. No files uploaded.`,f.ERROR),r=!1),R.current>0&&(a("Already uploading files.  Please wait before sending more.",f.ERROR),r=!1),i.map(e=>{e.size>=1e6&&(a(`File '${e.name}' is larger than 1MB. No files uploaded.`,f.ERROR),r=!1)}),r&&(R.current=i.length,i.map(e=>{let p={fileName:e.name,size:e.size,progressPercent:0};D(o=>[...o,p])}),i.map((e,p)=>{const o=new FileReader;o.readAsDataURL(e),o.onabort=()=>{},o.onerror=()=>{},o.onload=()=>{const h=new FormData;h.append("file",e),h.append("doenetId",l),b.post("/api/upload.php",h,{onUploadProgress:d=>{const m=d.lengthComputable?d.total:d.target.getResponseHeader("content-length")||d.target.getResponseHeader("x-decompressed-content-length");if(m!==null){let I=Math.round(d.loaded*100/m);D(O=>{let B=[...O];return B[p].progressPercent=I,B})}}}).then(({data:d})=>{R.current=R.current-1,R.current<1&&D([]);let{success:m,fileName:I,cid:O,asFileName:B,width:ae,height:oe,msg:E,userQuotaBytesAvailable:le}=d;E&&(m?a(E,f.INFO):a(E,f.ERROR)),m&&w(U=>{let M={...U},k=[...U.supportingFiles];return k.push({cid:O,fileName:I,fileType:e.type,width:ae,height:oe,description:"",asFileName:B}),M.supportingFiles=k,M.userQuotaBytesAvailable=le,M})})}}))},[]),{getRootProps:Z,getInputProps:ee,isDragActive:te}=de({onDrop:Y});let ie=V.map(i=>u("div",{children:[i.fileName," - ",i.progressPercent,"%"]},`${i.fileName}`)),j=null;F&&(j=u(ue,{children:[u("div",{children:[y,"/",v," Bytes"]}),u("div",{...Z(),children:[t("input",{...ee()}),te?t("p",{children:"Drop the files here"}):t(he,{vertical:!0,children:t(ce,{width:"menu",value:"Upload files"})})]},"drop"),t(me,{title:"Accepted File Types",collapsed:!0,children:u("div",{children:[t("b",{children:"Image"}),".jpg .png .csv"]})}),ie]}));let P=[];return S.map(({cid:i,fileName:r,fileType:s,width:c,height:g,description:e,asFileName:p})=>{let o="Error",h=`doenet:cid=${i}`;if(s==="image/jpeg"||s==="image/png"){o=`<image source='${h}' description='${e}' asfilename='${p}' width='${c}' height='${g}' mimeType='${s}' />`;let d={};P.push(u("div",{children:[u("div",{children:[t("span",{style:{width:"116px"},children:"asFileName:"}),t(T,{text:p,submit:m=>{_(m,i)}})]}),u("div",{style:d,children:[t("span",{style:{width:"116px"},children:"description:"}),t(T,{text:e,submit:m=>{W(m,i)}})]}),t("div",{children:u(q,{width:"menu",children:[F?t(C,{alert:!0,value:"Delete",onClick:()=>{z(i)}}):null,t(G.CopyToClipboard,{onCopy:()=>a("Code copied to clipboard!",f.SUCCESS),text:o,children:t(C,{disabled:e=="",icon:t(Q,{icon:H}),value:"Copy Code"})})]})}),t("hr",{})]},`${i}`))}else s==="text/csv"&&(o=`<dataFrame source='${h}' hasHeader="true" />`,P.push(u("div",{children:[t("div",{children:u("span",{style:{width:"116px"},children:["fileName: ",t(T,{text:p,submit:d=>{_(d,i)}})]})}),t("div",{children:u(q,{width:"menu",children:[F?t(C,{alert:!0,value:"Delete",onClick:()=>{z(i)}}):null,t(G.CopyToClipboard,{onCopy:()=>a("Code copied to clipboard!",f.SUCCESS),text:o,children:t(C,{icon:t(Q,{icon:H}),value:"Copy Code"})})]})}),t("hr",{})]},`${i}`)))}),u("div",{children:[j,t("br",{}),P]})}export{Be as default};
