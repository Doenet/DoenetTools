---
import { getCollection, render } from "astro:content";
import { newsletterStyles } from "../utils/newsletterStyles";
import { newsletterConfig } from "../utils/newsletter-config";

// Note: Helper functions (escapeRegExp, extractUntilMarker, cleanForEmail, applyEmailStyles)
// are inlined directly in the client-side script to avoid eval and CSP issues.

// ============================================================================
// Newsletter configuration is sourced from environment variables.
// See blog/.env.example for the available keys.
// ============================================================================

// ============================================================================
// DATA FETCHING AND PROCESSING
// ============================================================================

// Fetch all blog posts
const allPosts = await getCollection("blog");

// Filter and sort posts by ordered slug list
const manualOrder = newsletterConfig.manualOrder;
const manualIndex = new Map<string, number>(
  manualOrder.map((slug, index) => [slug, index]),
);
const recentPosts = allPosts
  .filter((post) => manualIndex.has(post.id.replace(/\.(md|mdx)$/, "")))
  .sort((a, b) => {
    const slugA = a.id.replace(/\.(md|mdx)$/, "");
    const slugB = b.id.replace(/\.(md|mdx)$/, "");
    const indexA = manualIndex.get(slugA) ?? 0;
    const indexB = manualIndex.get(slugB) ?? 0;
    return indexA - indexB;
  });

// Render posts and extract excerpts
const postsWithExcerpts = await Promise.all(
  recentPosts.map(async (post) => {
    const { Content } = await render(post);
    // Use post.id as the slug (filename without extension)
    const slug = post.id.replace(/\.(md|mdx)$/, "");
    const config = { untilMarker: newsletterConfig.excerptMarker };

    return {
      post,
      slug,
      Content,
      config,
    };
  }),
);

const siteUrl = Astro.site ? Astro.site.toString().replace(/\/$/, "") : "";
const blogBasePath = import.meta.env.BASE_URL || "/";

// For newsletter images, always use the production URL so they work in emails
const productionUrl = "https://beta.doenet.org";
const logoUrl = `${productionUrl}${blogBasePath}/Doenet_Logo_Frontpage_color_text.png`;

const issueDateFormatted = newsletterConfig.issueDate.toLocaleDateString(
  "en-US",
  {
    year: "numeric",
    month: "short",
  },
);
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Doenet {issueDateFormatted} Newsletter</title>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        line-height: 1.6;
        color: #333;
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem;
      }
      .controls {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .controls h1 {
        margin: 0 0 0.5rem 0;
        font-size: 1.8rem;
      }
      .controls p {
        margin: 0 0 1rem 0;
        color: #666;
      }
      .button {
        display: inline-block;
        padding: 0.75rem 1.5rem;
        background: #0066cc;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        text-decoration: none;
        transition: background 0.2s;
      }
      .button:hover {
        background: #0052a3;
      }
      .stats {
        margin-top: 1rem;
        padding: 1rem;
        background: #f0f7ff;
        border-radius: 4px;
        font-size: 0.9rem;
      }
      #newsletter-content {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .hidden-content {
        display: none;
      }
    </style>
  </head>
  <body>
    <!-- Controls Section -->
    <div class="controls">
      <h1>üìß Newsletter Generator</h1>
      <p>
        This page generates an email-friendly HTML newsletter from the posts
        listed in the configuration.
      </p>

      <button class="button" id="download-btn">
        ‚¨áÔ∏è Download Newsletter HTML
      </button>
      <button
        class="button"
        id="copy-btn"
        style="background: #28a745; margin-left: 0.5rem;"
      >
        üìã Copy HTML to Clipboard
      </button>
    </div>

    <!-- Newsletter Content (this is what gets downloaded/copied) -->
    <div id="newsletter-content">
      <!-- Email-friendly container -->
      <table
        role="presentation"
        style="width: 600px; margin: 0 auto; border-collapse: collapse; font-family: sans-serif;"
      >
        <!-- Header -->
        <tr>
          <td
            style="padding: 1em; background: #ffffff; border-bottom: 3px solid #0066cc;"
          >
            <table
              role="presentation"
              style="width: 100%; border-collapse: collapse;"
            >
              <tr>
                <td style="text-align: left; vertical-align: bottom;">
                  <span
                    style="font-size: 1.2em; color: #666; font-family: sans-serif;"
                  >
                    {issueDateFormatted} Newsletter
                  </span>
                </td>
                <td style="text-align: right; vertical-align: bottom;">
                  <img
                    src={logoUrl}
                    alt="Doenet"
                    style="height: 50px; width: auto; display: inline-block; margin: 0 0 -12px 0;"
                  />
                </td>
              </tr>
            </table>
          </td>
        </tr>

        <!-- Spacer -->
        <tr>
          <td style="height: 2em;"></td>
        </tr>
      </table>

      <!-- Posts -->
      {
        postsWithExcerpts.map(({ post, slug, Content, config }) => {
          return (
            <>
              {/* Render the full content in a hidden div so we can extract from it */}
              <div
                class="hidden-content"
                data-post-slug={slug}
                data-config={JSON.stringify(config)}
              >
                <Content />
              </div>

              {/* This div will be populated with the excerpt via client-side script */}
              <div
                id={`post-${slug}`}
                data-post-slug={slug}
                data-title={post.data.title}
                data-description={post.data.description}
                data-author={post.data.author}
                data-organization={post.data.organization || ""}
                data-date={post.data.pubDate.toISOString()}
                data-hero-image={post.data.heroImage || ""}
              />
            </>
          );
        })
      }

      <!-- Footer -->
      <table
        role="presentation"
        style="width: 600px; margin: 2em auto 0 auto; border-collapse: collapse; font-family: sans-serif;"
      >
        <tr>
          <td
            style="padding: 1.5em 1em; text-align: center; background: #f8f9fa; border-top: 1px solid #e0e0e0;"
          >
            <p
              style="margin: 0; font-size: 0.85em; color: #666; font-family: sans-serif;"
            >
              Visit the <a
                href={`${siteUrl}${blogBasePath}`.replace(/\/$/, "")}
                style="color: #0066cc; text-decoration: underline;"
                >Doenet Blog</a
              > for more updates. Licensed under
              <a
                href="https://creativecommons.org/licenses/by/4.0/"
                style="color: #0066cc; text-decoration: underline;"
                target="_blank"
                rel="noopener noreferrer"
              >
                CC BY 4.0
              </a>.
            </p>
          </td>
        </tr>
      </table>
    </div>

    <!-- Client-side script to extract excerpts and populate posts -->
    <script
      is:inline
      define:vars={{
        siteUrl,
        blogBasePath,
        productionUrl,
        newsletterStylesJSON: JSON.stringify(newsletterStyles),
      }}
    >
      // Escape a string so it can be safely used inside a RegExp as a literal.
      function escapeRegExp(str) {
        return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      }

      // Extract content up to a marker comment/element (HTML, MDX, or data-excerpt)
      // HTML: <!-- more -->
      // MDX:  {/* more */}
      // Element: <span data-excerpt style="display:none"></span>
      function extractUntilMarker(html, marker = "more") {
        const escapedMarker = escapeRegExp(marker);
        const htmlComment = `<!--\\s*${escapedMarker}\\s*-->`;
        const mdxComment = `\\{\\/\\*\\s*${escapedMarker}\\s*\\*\\/\\}`;
        const dataMarker = `<[^>]*\\sdata-excerpt(?:\\s|=|>|/)[^>]*>`;
        const markerPattern = new RegExp(
          `${htmlComment}|${mdxComment}|${dataMarker}`,
          "i",
        );
        const match = html.match(markerPattern);

        if (match && match.index !== undefined) {
          return html.substring(0, match.index).trim();
        }

        return html;
      }

      // Clean HTML for email compatibility and security
      // - Remove script tags and style tags
      // - Remove dangerous/interactive elements (button, form, iframe, object, embed, etc.)
      // - Strip all event handler attributes (on*, data-*, dangerous protocols)
      // - Sanitize href/src attributes to prevent javascript: and data: URLs
      function cleanForEmail(html) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");

        // Elements to completely remove (dangerous or non-email-compatible)
        const dangerousTags = [
          "script",
          "style",
          "button",
          "input",
          "textarea",
          "select",
          "form",
          "iframe",
          "object",
          "embed",
          "applet",
          "base",
          "link",
          "meta",
        ];

        dangerousTags.forEach((tag) => {
          doc.querySelectorAll(tag).forEach((el) => el.remove());
        });

        // Strip dangerous attributes from all elements
        doc.querySelectorAll("*").forEach((el) => {
          // Remove all event handler attributes (on*, data-*)
          Array.from(el.attributes).forEach((attr) => {
            if (
              attr.name.startsWith("on") || // onclick, onerror, onload, etc.
              attr.name.startsWith("data-") // Remove data attributes for safety
            ) {
              el.removeAttribute(attr.name);
            }
          });

          // Sanitize href and src attributes
          const href = el.getAttribute("href");
          const src = el.getAttribute("src");

          if (
            href &&
            (href.startsWith("javascript:") || href.startsWith("data:"))
          ) {
            el.removeAttribute("href");
          }

          if (
            src &&
            (src.startsWith("javascript:") || src.startsWith("data:"))
          ) {
            el.removeAttribute("src");
          }

          // Remove aria-* attributes that might execute code in some email clients
          Array.from(el.attributes).forEach((attr) => {
            if (
              attr.name.startsWith("aria-") &&
              attr.value.includes("javascript")
            ) {
              el.removeAttribute(attr.name);
            }
          });
        });

        return doc.body.innerHTML;
      }

      // Apply inline styles for email compatibility
      function applyEmailStyles(html) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");

        // Style paragraphs
        doc.querySelectorAll("p").forEach((p) => {
          p.setAttribute(
            "style",
            "margin: 0 0 1em 0; line-height: 1.6; color: #333; font-size: 18px;",
          );
        });

        // Style headings
        doc.querySelectorAll("h1").forEach((h) => {
          h.setAttribute(
            "style",
            "margin: 1.5em 0 0.5em 0; line-height: 1.3; color: #1a1a1a; font-size: 32px;",
          );
        });

        doc.querySelectorAll("h2").forEach((h) => {
          h.setAttribute(
            "style",
            "margin: 1.5em 0 0.5em 0; line-height: 1.3; color: #1a1a1a; font-size: 28px;",
          );
        });

        doc.querySelectorAll("h3").forEach((h) => {
          h.setAttribute(
            "style",
            "margin: 1.5em 0 0.5em 0; line-height: 1.3; color: #1a1a1a; font-size: 24px;",
          );
        });

        doc.querySelectorAll("h4, h5, h6").forEach((h) => {
          h.setAttribute(
            "style",
            "margin: 1.5em 0 0.5em 0; line-height: 1.3; color: #1a1a1a; font-size: 20px;",
          );
        });

        // Style links
        doc.querySelectorAll("a").forEach((a) => {
          a.setAttribute(
            "style",
            "color: #0066cc; text-decoration: underline; font-size: 18px;",
          );
        });

        // Style lists
        doc.querySelectorAll("ul, ol").forEach((list) => {
          list.setAttribute(
            "style",
            "margin: 0 0 1em 0; padding-left: 2em; font-size: 18px;",
          );
        });

        doc.querySelectorAll("li").forEach((li) => {
          li.setAttribute(
            "style",
            "margin: 0 0 0.5em 0; line-height: 1.6; font-size: 18px;",
          );
        });

        // Style code blocks
        doc.querySelectorAll("pre").forEach((pre) => {
          pre.setAttribute(
            "style",
            "background: #f5f5f5; padding: 1em; border-radius: 4px; overflow-x: auto; margin: 1em 0; font-size: 16px;",
          );
        });

        doc.querySelectorAll("code").forEach((code) => {
          if (code.parentElement?.tagName !== "PRE") {
            code.setAttribute(
              "style",
              "background: #f5f5f5; padding: 0.2em 0.4em; border-radius: 3px; font-family: monospace; font-size: 16px;",
            );
          }
        });

        // Style blockquotes
        doc.querySelectorAll("blockquote").forEach((bq) => {
          bq.setAttribute(
            "style",
            "border-left: 4px solid #ddd; padding-left: 1em; margin: 1em 0; color: #666; font-size: 18px;",
          );
        });

        // Style images
        doc.querySelectorAll("img").forEach((img) => {
          img.setAttribute(
            "style",
            "max-width: 100%; height: auto; display: block; margin: 1em 0;",
          );
        });

        return doc.body.innerHTML;
      }

      // Escape HTML special characters to prevent injection
      function escapeHtml(text) {
        if (!text) return text;
        const map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;",
        };
        return text.replace(/[&<>"']/g, (char) => map[char]);
      }

      // Parse styles from JSON
      const styleSheet = JSON.parse(newsletterStylesJSON);

      function absolutizeUrl(rawUrl) {
        if (!rawUrl) return rawUrl;
        const url = rawUrl.trim();
        if (!url) return url;

        if (/^(https?:|mailto:|tel:|data:|#)/i.test(url)) {
          return url;
        }

        if (url.startsWith("//")) {
          return `https:${url}`;
        }

        // Use production URL for all absolute and relative paths
        if (url.startsWith("/")) {
          return `${productionUrl}${url}`;
        }

        // For relative URLs, construct full URL with production base
        const base = `${productionUrl}${blogBasePath}`.replace(/\/$/, "");
        const relative = url.replace(/^\.\//, "");
        return `${base}/${relative}`;
      }

      function rewriteUrls(html) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");

        doc.querySelectorAll("img").forEach((img) => {
          const src = img.getAttribute("src");
          if (src) {
            const absoluteUrl = absolutizeUrl(src);
            img.setAttribute("src", absoluteUrl);
          }

          const srcset = img.getAttribute("srcset");
          if (srcset) {
            const updated = srcset
              .split(",")
              .map((part) => {
                const trimmed = part.trim();
                if (!trimmed) return trimmed;
                const [urlPart, sizePart] = trimmed.split(/\s+/, 2);
                const absUrl = absolutizeUrl(urlPart);
                return sizePart ? `${absUrl} ${sizePart}` : absUrl;
              })
              .join(", ");
            img.setAttribute("srcset", updated);
          }
        });

        doc.querySelectorAll("a").forEach((a) => {
          const href = a.getAttribute("href");
          if (href) {
            a.setAttribute("href", absolutizeUrl(href));
          }
        });

        return doc.body.innerHTML;
      }

      // Process each post
      document.addEventListener("DOMContentLoaded", () => {
        const hiddenContents = document.querySelectorAll(".hidden-content");

        hiddenContents.forEach((hiddenDiv) => {
          const slug = hiddenDiv.getAttribute("data-post-slug");
          const config = JSON.parse(hiddenDiv.getAttribute("data-config"));
          const targetDiv = document.getElementById(`post-${slug}`);

          if (!targetDiv) return;

          // Get the rendered HTML from the hidden div
          let html = hiddenDiv.innerHTML;

          // Extract excerpt based on config
          const excerpt = extractUntilMarker(html, config.untilMarker);

          // Clean and style for email
          let processedExcerpt = cleanForEmail(excerpt);
          processedExcerpt = applyEmailStyles(processedExcerpt);
          processedExcerpt = rewriteUrls(processedExcerpt);

          // Get post metadata
          const title = targetDiv.getAttribute("data-title");
          const description = targetDiv.getAttribute("data-description");
          const author = targetDiv.getAttribute("data-author");
          const organization = targetDiv.getAttribute("data-organization");
          const heroImage = targetDiv.getAttribute("data-hero-image");

          // Escape HTML in metadata to prevent injection
          const escapedTitle = escapeHtml(title);
          const escapedAuthor = escapeHtml(author);
          const escapedOrganization = escapeHtml(organization);
          const escapedDescription = escapeHtml(description);

          // Build the post HTML
          const blogBaseUrl = `${siteUrl}${blogBasePath}`.replace(/\/$/, "");
          const postUrl = `${blogBaseUrl}/${slug}`;

          // Build hero image HTML if available
          const heroImageHtml = heroImage
            ? `
            <tr>
              <td style="${styleSheet.cell}">
                <img src="${absolutizeUrl(heroImage)}" alt="${escapedTitle}" style="max-width: 100%; height: auto; display: block; margin: 0 0 1em 0; border-radius: 4px;" />
              </td>
            </tr>
          `
            : "";

          const postHtml = `
            <table role="presentation" style="${styleSheet.table}">
              ${heroImageHtml}
              <tr>
                <td style="${styleSheet.headerCell}">
                  <h2 style="${styleSheet.title}">
                    <a href="${postUrl}" style="${styleSheet.titleLink}" target="_blank" rel="noopener noreferrer">
                      ${escapedTitle}
                    </a>
                  </h2>
                  <p style="${styleSheet.meta}">
                    By ${escapedAuthor}${escapedOrganization ? ` (${escapedOrganization})` : ""}
                  </p>
                </td>
              </tr>
              <tr>
                <td style="${styleSheet.cell}">
                  <div style="${styleSheet.body}">
                    ${processedExcerpt}
                  </div>
                  <p style="${styleSheet.buttonWrap}">
                    <a href="${postUrl}" style="${styleSheet.button}" target="_blank" rel="noopener noreferrer">
                      Read Full Post ‚Üí
                    </a>
                  </p>
                </td>
              </tr>
            </table>
          `;

          targetDiv.innerHTML = postHtml;
        });

        // Remove hidden content divs from the newsletter content
        hiddenContents.forEach((div) => div.remove());

        // Attach event listeners to buttons
        const downloadBtn = document.getElementById("download-btn");
        const copyBtn = document.getElementById("copy-btn");

        if (downloadBtn) {
          downloadBtn.addEventListener("click", downloadNewsletter);
        }
        if (copyBtn) {
          copyBtn.addEventListener("click", copyToClipboard);
        }
      });

      // Download newsletter as HTML file
      function downloadNewsletter() {
        const content = document.getElementById("newsletter-content");
        const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${escapeHtml(document.title)}</title>
</head>
<body style="margin: 0; padding: 0; font-family: sans-serif; font-size: 18px; background-color: #f5f5f5;">
  <table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0" style="margin: 0; padding: 0;">
    <tr>
      <td align="center" style="padding: 20px 0;">
        <table role="presentation" width="600" cellpadding="0" cellspacing="0" border="0" style="width: 600px; background-color: #ffffff;">
          <tr>
            <td>
${content.innerHTML}
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>`;

        const blob = new Blob([html], { type: "text/html" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `doenet-newsletter-${new Date().toISOString().split("T")[0]}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Copy newsletter HTML to clipboard
      function copyToClipboard() {
        const content = document.getElementById("newsletter-content");
        const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${escapeHtml(document.title)}</title>
</head>
<body style="margin: 0; padding: 0; font-family: sans-serif; font-size: 18px; background-color: #f5f5f5;">
  <table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0" style="margin: 0; padding: 0;">
    <tr>
      <td align="center" style="padding: 20px 0;">
        <table role="presentation" width="600" cellpadding="0" cellspacing="0" border="0" style="width: 600px; background-color: #ffffff;">
          <tr>
            <td>
${content.innerHTML}
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>`;

        navigator.clipboard
          .writeText(html)
          .then(() => {
            alert("Newsletter HTML copied to clipboard!");
          })
          .catch((err) => {
            console.error("Failed to copy:", err);
            alert(
              "Failed to copy to clipboard. Please try the download option.",
            );
          });
      }
    </script>
  </body>
</html>
